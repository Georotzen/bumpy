<!--
Automatically generated HTML file from DocOnce source
(https://github.com/hplgit/doconce/)
-->
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="DocOnce: https://github.com/hplgit/doconce/" />
<meta name="description" content="A worked example on scientific computing with Python">

<title>A worked example on scientific computing with Python</title>


<style type="text/css">
/* bloodish style */

body {
  font-family: Helvetica, Verdana, Arial, Sans-serif;
  color: #404040;
  background: #ffffff;
}
h1 { font-size: 1.8em;  color: #8A0808; }
h2 { font-size: 1.6em;  color: #8A0808; }
h3 { font-size: 1.4em;  color: #8A0808; }
h4 { color: #8A0808; }
a { color: #8A0808; text-decoration:none; }
tt { font-family: "Courier New", Courier; }
/* pre style removed because it will interfer with pygments */
p { text-indent: 0px; }
hr { border: 0; width: 80%; border-bottom: 1px solid #aaa}
p.caption { width: 80%; font-style: normal; text-align: left; }
hr.figure { border: 0; width: 80%; border-bottom: 1px solid #aaa}

div { text-align: justify; text-justify: inter-word; }
</style>


</head>

<!-- tocinfo
{'highest level': 1,
 'sections': [(' Contents ', 2, None, '___sec0'),
              (' The following programming topics are illustrated ',
               2,
               None,
               '___sec1'),
              (' A scientific application ', 1, None, '___sec2'),
              (' Physical problem and mathematical model ',
               2,
               None,
               '___sec3'),
              (' Numerical model ', 2, None, '___sec4'),
              (' Extension to quadratic damping ', 2, None, '___sec5'),
              (' Simple implementation ', 2, None, '___sec6'),
              (' Using the function ', 2, None, '___sec7'),
              (' Plot ', 2, None, '___sec8'),
              (' More advanced implementation (part I) ', 2, None, '___sec9'),
              (' More advanced implementation (part II) ',
               2,
               None,
               '___sec10'),
              (' Important features ', 2, None, '___sec11'),
              (' Using the solver function ', 2, None, '___sec12'),
              (' Local vs global variables ', 2, None, '___sec13'),
              (' Advanced programming of functions with parameters ',
               2,
               None,
               '___sec14'),
              (' The excitation force ', 2, None, '___sec15'),
              (' Computing the force from the road profile ',
               2,
               None,
               '___sec16'),
              (' Vectorized version of the previous function ',
               2,
               None,
               '___sec17'),
              (' Performing the simulation of vibrations ',
               2,
               None,
               '___sec18'),
              (' A high-level solve function (part I) ', 2, None, '___sec19'),
              (' A high-level solve function (part II) ',
               2,
               None,
               '___sec20'),
              (' Computing an expression for the noise level of the vibrations ',
               2,
               None,
               '___sec21'),
              (' Pickling objects to file ', 2, None, '___sec22'),
              (' User input ', 1, None, '___sec23'),
              (' Positional command-line arguments ', 2, None, '___sec24'),
              (' Option-value pairs on the command line ',
               2,
               None,
               '___sec25'),
              (' Example on using `argparse` ', 2, None, '___sec26'),
              (' Visual exploration ', 1, None, '___sec27'),
              (' Code (part I) ', 2, None, '___sec28'),
              (' Code (part II) ', 2, None, '___sec29'),
              (' Code (part III) ', 2, None, '___sec30'),
              (' Plot of the spectrum ', 2, None, '___sec31'),
              (' Code (part IV) ', 2, None, '___sec32'),
              (' Plot ', 2, None, '___sec33'),
              (' Advanced topics ', 1, None, '___sec34'),
              (' Symbolic computing via SymPy ', 2, None, '___sec35'),
              (' Go seamlessly from symbolic expression to Python function ',
               2,
               None,
               '___sec36'),
              (' Testing via test functions and test frameworks ',
               2,
               None,
               '___sec37'),
              (' Example on a test function ', 2, None, '___sec38'),
              (' Test function for the numerical solver (part I) ',
               2,
               None,
               '___sec39'),
              (' Test function for the numerical solver (part II) ',
               2,
               None,
               '___sec40'),
              (' Using a test framework ', 2, None, '___sec41'),
              (' Modules ', 2, None, '___sec42'),
              (' Example on a module file ', 2, None, '___sec43'),
              (' What gets imported? ', 2, None, '___sec44')]}
end of tocinfo -->

<body>



<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  TeX: {
     equationNumbers: {  autoNumber: "AMS"  },
     extensions: ["AMSmath.js", "AMSsymbols.js", "autobold.js", "color.js"]
  }
});
</script>
<script type="text/javascript"
 src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>



    
<!-- ------------------- main content ---------------------- -->



<center><h1>A worked example on scientific computing with Python</h1></center>  <!-- document title -->

<p>
<!-- author(s): Hans Petter Langtangen -->

<center>
<b>Hans Petter Langtangen</b> [1, 2] (<tt>hpl at simula.no</tt>)
</center>


<p>
<!-- institution(s) -->

<center>[1] <b>Simula Research Laboratory</b></center>
<center>[2] <b>University of Oslo</b></center>
<p>
<center><h4>Jan 13, 2015</h4></center> <!-- date -->
<p>
<center><p><img src="fig-bumpy/bumpy_road_sign1.jpg" align="bottom" width=100></p></center>

<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2 id="___sec0">Contents </h2>

<p>
This worked example

<ul>
  <li> fetches a data file from a web site,</li>
  <li> applies that file as input data for a differential equation modeling a vibrating system,</li>
  <li> solves the equation by a finite difference method,</li>
  <li> visualizes various properties of the solution and the input data.</li>
</ul>

<!-- !split --><br><br><br><br><br><br><br><br>

<h2 id="___sec1">The following programming topics are illustrated </h2>

<ul>
  <li> basic Python constructs: variables, loops, if-tests, arrays, functions</li>
  <li> flexible storage of objects in lists</li>
  <li> storage of objects in files (persistence)</li>
  <li> downloading files from the web</li>
  <li> user input via the command line</li>
  <li> signal processing and FFT</li>
  <li> curve plotting of data</li>
  <li> testing</li>
  <li> modules</li>
</ul>

All files can be forked at <a href="https://github.com/hplgit/bumpy" target="_blank"><tt>https://github.com/hplgit/bumpy</tt></a>

<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2>Table of contents</h2>

<p>
&nbsp; &nbsp; &nbsp; <a href="#___sec0"> Contents </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec1"> The following programming topics are illustrated </a><br>
<a href="#___sec2"> A scientific application </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec3"> Physical problem and mathematical model </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec4"> Numerical model </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec5"> Extension to quadratic damping </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec6"> Simple implementation </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec7"> Using the function </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec8"> Plot </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec9"> More advanced implementation (part I) </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec10"> More advanced implementation (part II) </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec11"> Important features </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec12"> Using the solver function </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec13"> Local vs global variables </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec14"> Advanced programming of functions with parameters </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec15"> The excitation force </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec16"> Computing the force from the road profile </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec17"> Vectorized version of the previous function </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec18"> Performing the simulation of vibrations </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec19"> A high-level solve function (part I) </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec20"> A high-level solve function (part II) </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec21"> Computing an expression for the noise level of the vibrations </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec22"> Pickling objects to file </a><br>
<a href="#___sec23"> User input </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec24"> Positional command-line arguments </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec25"> Option-value pairs on the command line </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec26"> Example on using <code>argparse</code> </a><br>
<a href="#___sec27"> Visual exploration </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec28"> Code (part I) </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec29"> Code (part II) </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec30"> Code (part III) </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec31"> Plot of the spectrum </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec32"> Code (part IV) </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec33"> Plot </a><br>
<a href="#___sec34"> Advanced topics </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec35"> Symbolic computing via SymPy </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec36"> Go seamlessly from symbolic expression to Python function </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec37"> Testing via test functions and test frameworks </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec38"> Example on a test function </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec39"> Test function for the numerical solver (part I) </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec40"> Test function for the numerical solver (part II) </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec41"> Using a test framework </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec42"> Modules </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec43"> Example on a module file </a><br>
&nbsp; &nbsp; &nbsp; <a href="#___sec44"> What gets imported? </a><br>
</p>
<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h1 id="___sec2">A scientific application </h1>

<p>
<center><p><img src="fig-bumpy/bumpy_road1.jpg" align="bottom" width=400></p></center>

<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2 id="___sec3">Physical problem and mathematical model </h2>

$$
\begin{equation}
mu'' + f(u') + s(u) = F(t),\quad u(0)=I,\ u'(0)=V
\label{bumpy:eq1}
\end{equation}
$$


<ul>
 <li> Input: mass \( m \), friction force \( f(u') \), spring \( s(u) \), external
   forcing \( F(t) \), \( I \), \( V \)</li>
 <li> Output: vertical displacement \( u(t) \)</li>
</ul>

<center><p><img src="fig-bumpy/vehicle2.png" align="bottom" width=500></p></center>

<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2 id="___sec4">Numerical model </h2>

<ul>
 <li> Finite difference method</li>
 <li> Centered differences</li>
 <li> \( u^n \): approximation to exact \( u \) at \( t=t_n=n\Delta t \)</li>
 <li> First: linear damping</li>
</ul>

$$
\begin{equation*}
u^{n+1} = \left(2mu^n + (\frac{b}{2}\Delta t - m)u^{n-1} +
\Delta t^2(F^n - s(u^n))
\right)(m + \frac{b}{2}\Delta t)^{-1}
\end{equation*}
$$


<p>
A special formula must be applied for \( n=0 \):

$$
\begin{equation*}
u^1 = u^0 + \Delta t\, V
+ \frac{\Delta t^2}{2m}(-bV - s(u^0) + F^0)
\end{equation*}
$$


<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2 id="___sec5">Extension to quadratic damping </h2>

<p>
Linearization via geometric mean:

$$
f(u'(t_n)) = \left. |u'|u'\right\vert^n \approx |u'|^{n-\frac{1}{2}}
(u')^{n+\frac{1}{2}}
$$


$$
\begin{align*}
u^{n+1} = & \left( m + b|u^n-u^{n-1}|\right)^{-1}\times \\ 
&\quad \left(2m u^n - mu^{n-1} + bu^n|u^n-u^{n-1}| + \Delta t^2 (F^n - s(u^n))
\right)
\end{align*}
$$


<p>
(and again a special formula for \( u^1 \))

<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2 id="___sec6">Simple implementation </h2>

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">numpy</span> <span style="color: #008000; font-weight: bold">import</span> <span style="color: #666666">*</span>

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">solver_linear_damping</span>(I, V, m, b, s, F, t):
    N <span style="color: #666666">=</span> t<span style="color: #666666">.</span>size <span style="color: #666666">-</span> <span style="color: #666666">1</span>              <span style="color: #408080; font-style: italic"># No of time intervals</span>
    dt <span style="color: #666666">=</span> t[<span style="color: #666666">1</span>] <span style="color: #666666">-</span> t[<span style="color: #666666">0</span>]            <span style="color: #408080; font-style: italic"># Time step</span>
    u <span style="color: #666666">=</span> zeros(N<span style="color: #666666">+1</span>)              <span style="color: #408080; font-style: italic"># Result array</span>
    u[<span style="color: #666666">0</span>] <span style="color: #666666">=</span> I
    u[<span style="color: #666666">1</span>] <span style="color: #666666">=</span> u[<span style="color: #666666">0</span>] <span style="color: #666666">+</span> dt<span style="color: #666666">*</span>V <span style="color: #666666">+</span> dt<span style="color: #666666">**2/</span>(<span style="color: #666666">2*</span>m)<span style="color: #666666">*</span>(<span style="color: #666666">-</span>b<span style="color: #666666">*</span>V <span style="color: #666666">-</span> s(u[<span style="color: #666666">0</span>]) <span style="color: #666666">+</span> F[<span style="color: #666666">0</span>])

    <span style="color: #008000; font-weight: bold">for</span> n <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">range</span>(<span style="color: #666666">1</span>,N):
        u[n<span style="color: #666666">+1</span>] <span style="color: #666666">=</span> <span style="color: #666666">1./</span>(m <span style="color: #666666">+</span> b<span style="color: #666666">*</span>dt<span style="color: #666666">/2</span>)<span style="color: #666666">*</span>(<span style="color: #666666">2*</span>m<span style="color: #666666">*</span>u[n] <span style="color: #666666">+</span> \ 
                 (b<span style="color: #666666">*</span>dt<span style="color: #666666">/2</span> <span style="color: #666666">-</span> m)<span style="color: #666666">*</span>u[n<span style="color: #666666">-1</span>] <span style="color: #666666">+</span> dt<span style="color: #666666">**2*</span>(F[n] <span style="color: #666666">-</span> s(u[n])))
    <span style="color: #008000; font-weight: bold">return</span> u
</pre></div>
<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2 id="___sec7">Using the function </h2>

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">solver</span> <span style="color: #008000; font-weight: bold">import</span> solver_linear_damping
<span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">numpy</span> <span style="color: #008000; font-weight: bold">import</span> <span style="color: #666666">*</span>

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">s</span>(u):
    <span style="color: #008000; font-weight: bold">return</span> <span style="color: #666666">2*</span>u

T <span style="color: #666666">=</span> <span style="color: #666666">10*</span>pi      <span style="color: #408080; font-style: italic"># simulate for t in [0,T]</span>
dt <span style="color: #666666">=</span> <span style="color: #666666">0.2</span>
N <span style="color: #666666">=</span> <span style="color: #008000">int</span>(<span style="color: #008000">round</span>(T<span style="color: #666666">/</span>dt))
t <span style="color: #666666">=</span> linspace(<span style="color: #666666">0</span>, T, N<span style="color: #666666">+1</span>)
F <span style="color: #666666">=</span> zeros(t<span style="color: #666666">.</span>size)
I <span style="color: #666666">=</span> <span style="color: #666666">1</span>; V <span style="color: #666666">=</span> <span style="color: #666666">0</span>
m <span style="color: #666666">=</span> <span style="color: #666666">2</span>; b <span style="color: #666666">=</span> <span style="color: #666666">0.2</span>
u <span style="color: #666666">=</span> solver_linear_damping(I, V, m, b, s, F, t)

<span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">matplotlib.pyplot</span> <span style="color: #008000; font-weight: bold">import</span> <span style="color: #666666">*</span>
plot(t, u)
savefig(<span style="color: #BA2121">&#39;tmp.pdf&#39;</span>)   <span style="color: #408080; font-style: italic"># save plot to PDF file</span>
savefig(<span style="color: #BA2121">&#39;tmp.png&#39;</span>)   <span style="color: #408080; font-style: italic"># save plot to PNG file</span>
show()
</pre></div>
<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2 id="___sec8">Plot </h2>

<p>
<center><p><img src="fig-bumpy/solver_linear_damping.png" align="bottom" width=500></p></center>

<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2 id="___sec9">More advanced implementation (part I) </h2>

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">solver</span>(I, V, m, b, s, F, t, damping<span style="color: #666666">=</span><span style="color: #BA2121">&#39;linear&#39;</span>):
    <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;</span>
<span style="color: #BA2121; font-style: italic">    Solve m*u&#39;&#39; + f(u&#39;) + s(u) = F for time points in t.</span>
<span style="color: #BA2121; font-style: italic">    u(0)=I and u&#39;(0)=V,</span>
<span style="color: #BA2121; font-style: italic">    by a central finite difference method with time step dt.</span>
<span style="color: #BA2121; font-style: italic">    If damping is &#39;linear&#39;, f(u&#39;)=b*u, while if damping is</span>
<span style="color: #BA2121; font-style: italic">    &#39;quadratic&#39;, we have f(u&#39;)=b*u&#39;*abs(u&#39;).</span>
<span style="color: #BA2121; font-style: italic">    s(u) is a Python function, while F may be a function</span>
<span style="color: #BA2121; font-style: italic">    or an array (then F[i] corresponds to F at t[i]).</span>
<span style="color: #BA2121; font-style: italic">    &quot;&quot;&quot;</span>
    N <span style="color: #666666">=</span> t<span style="color: #666666">.</span>size <span style="color: #666666">-</span> <span style="color: #666666">1</span>              <span style="color: #408080; font-style: italic"># No of time intervals</span>
    dt <span style="color: #666666">=</span> t[<span style="color: #666666">1</span>] <span style="color: #666666">-</span> t[<span style="color: #666666">0</span>]            <span style="color: #408080; font-style: italic"># Time step</span>
    u <span style="color: #666666">=</span> np<span style="color: #666666">.</span>zeros(N<span style="color: #666666">+1</span>)           <span style="color: #408080; font-style: italic"># Result array</span>
    b <span style="color: #666666">=</span> <span style="color: #008000">float</span>(b); m <span style="color: #666666">=</span> <span style="color: #008000">float</span>(m)  <span style="color: #408080; font-style: italic"># Avoid integer division</span>

    <span style="color: #408080; font-style: italic"># Convert F to array</span>
    <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">callable</span>(F):
        F <span style="color: #666666">=</span> F(t)
    <span style="color: #008000; font-weight: bold">elif</span> <span style="color: #008000">isinstance</span>(F, (<span style="color: #008000">list</span>,<span style="color: #008000">tuple</span>,np<span style="color: #666666">.</span>ndarray)):
        F <span style="color: #666666">=</span> np<span style="color: #666666">.</span>asarray(F)
    <span style="color: #008000; font-weight: bold">else</span>:
        <span style="color: #008000; font-weight: bold">raise</span> <span style="color: #D2413A; font-weight: bold">TypeError</span>(
            <span style="color: #BA2121">&#39;F must be function or array, not </span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121">&#39;</span> <span style="color: #666666">%</span> <span style="color: #008000">type</span>(F))
</pre></div>
<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2 id="___sec10">More advanced implementation (part II) </h2>

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">solver</span>(I, V, m, b, s, F, t, damping<span style="color: #666666">=</span><span style="color: #BA2121">&#39;linear&#39;</span>):
    <span style="color: #666666">...</span>
    u[<span style="color: #666666">0</span>] <span style="color: #666666">=</span> I
    <span style="color: #008000; font-weight: bold">if</span> damping <span style="color: #666666">==</span> <span style="color: #BA2121">&#39;linear&#39;</span>:
        u[<span style="color: #666666">1</span>] <span style="color: #666666">=</span> u[<span style="color: #666666">0</span>] <span style="color: #666666">+</span> dt<span style="color: #666666">*</span>V <span style="color: #666666">+</span> dt<span style="color: #666666">**2/</span>(<span style="color: #666666">2*</span>m)<span style="color: #666666">*</span>(<span style="color: #666666">-</span>b<span style="color: #666666">*</span>V <span style="color: #666666">-</span> s(u[<span style="color: #666666">0</span>]) <span style="color: #666666">+</span> F[<span style="color: #666666">0</span>])
    <span style="color: #008000; font-weight: bold">elif</span> damping <span style="color: #666666">==</span> <span style="color: #BA2121">&#39;quadratic&#39;</span>:
        u[<span style="color: #666666">1</span>] <span style="color: #666666">=</span> u[<span style="color: #666666">0</span>] <span style="color: #666666">+</span> dt<span style="color: #666666">*</span>V <span style="color: #666666">+</span> \ 
               dt<span style="color: #666666">**2/</span>(<span style="color: #666666">2*</span>m)<span style="color: #666666">*</span>(<span style="color: #666666">-</span>b<span style="color: #666666">*</span>V<span style="color: #666666">*</span><span style="color: #008000">abs</span>(V) <span style="color: #666666">-</span> s(u[<span style="color: #666666">0</span>]) <span style="color: #666666">+</span> F[<span style="color: #666666">0</span>])
    <span style="color: #008000; font-weight: bold">else</span>:
        <span style="color: #008000; font-weight: bold">raise</span> <span style="color: #D2413A; font-weight: bold">ValueError</span>(<span style="color: #BA2121">&#39;Wrong value: damping=&quot;</span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121">&quot;&#39;</span> <span style="color: #666666">%</span> damping)

    <span style="color: #008000; font-weight: bold">for</span> n <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">range</span>(<span style="color: #666666">1</span>,N):
        <span style="color: #008000; font-weight: bold">if</span> damping <span style="color: #666666">==</span> <span style="color: #BA2121">&#39;linear&#39;</span>:
            u[n<span style="color: #666666">+1</span>] <span style="color: #666666">=</span> (<span style="color: #666666">2*</span>m<span style="color: #666666">*</span>u[n] <span style="color: #666666">+</span> (b<span style="color: #666666">*</span>dt<span style="color: #666666">/2</span> <span style="color: #666666">-</span> m)<span style="color: #666666">*</span>u[n<span style="color: #666666">-1</span>] <span style="color: #666666">+</span>
                      dt<span style="color: #666666">**2*</span>(F[n] <span style="color: #666666">-</span> s(u[n])))<span style="color: #666666">/</span>(m <span style="color: #666666">+</span> b<span style="color: #666666">*</span>dt<span style="color: #666666">/2</span>)
        <span style="color: #008000; font-weight: bold">elif</span> damping <span style="color: #666666">==</span> <span style="color: #BA2121">&#39;quadratic&#39;</span>:
            u[n<span style="color: #666666">+1</span>] <span style="color: #666666">=</span> (<span style="color: #666666">2*</span>m<span style="color: #666666">*</span>u[n] <span style="color: #666666">-</span> m<span style="color: #666666">*</span>u[n<span style="color: #666666">-1</span>] <span style="color: #666666">+</span> b<span style="color: #666666">*</span>u[n]<span style="color: #666666">*</span><span style="color: #008000">abs</span>(u[n] <span style="color: #666666">-</span> u[n<span style="color: #666666">-1</span>])
                      <span style="color: #666666">-</span> dt<span style="color: #666666">**2*</span>(s(u[n]) <span style="color: #666666">-</span> F[n]))<span style="color: #666666">/</span>\ 
                      (m <span style="color: #666666">+</span> b<span style="color: #666666">*</span><span style="color: #008000">abs</span>(u[n] <span style="color: #666666">-</span> u[n<span style="color: #666666">-1</span>]))
    <span style="color: #008000; font-weight: bold">return</span> u, t
</pre></div>
<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2 id="___sec11">Important features </h2>

<ul>
 <li> Two types of import: <code>import module</code> vs <code>from module import function</code></li>
 <li> Doc strings for documentation</li>
 <li> Avoiding integer division</li>
 <li> Flexible variable type: <code>F</code> can be function or array</li>
 <li> Checking correct variable type</li>
</ul>

<!-- !split --><br><br><br><br><br><br><br><br>

<h2 id="___sec12">Using the solver function </h2>

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">numpy</span> <span style="color: #008000; font-weight: bold">as</span> <span style="color: #0000FF; font-weight: bold">np</span>
<span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">numpy</span> <span style="color: #008000; font-weight: bold">import</span> sin, pi  <span style="color: #408080; font-style: italic"># for nice math</span>
<span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">solver</span> <span style="color: #008000; font-weight: bold">import</span> solver

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">F</span>(t):
    <span style="color: #408080; font-style: italic"># Sinusoidal bumpy road</span>
    <span style="color: #008000; font-weight: bold">return</span> A<span style="color: #666666">*</span>sin(pi<span style="color: #666666">*</span>t)

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">s</span>(u):
    <span style="color: #008000; font-weight: bold">return</span> k<span style="color: #666666">*</span>u

A <span style="color: #666666">=</span> <span style="color: #666666">0.25</span>
k <span style="color: #666666">=</span> <span style="color: #666666">2</span>
t <span style="color: #666666">=</span> np<span style="color: #666666">.</span>linspace(<span style="color: #666666">0</span>, <span style="color: #666666">20</span>, <span style="color: #666666">2001</span>)
u, t <span style="color: #666666">=</span> solver(I<span style="color: #666666">=0.1</span>, V<span style="color: #666666">=0</span>, m<span style="color: #666666">=2</span>, b<span style="color: #666666">=0.05</span>, s<span style="color: #666666">=</span>s, F<span style="color: #666666">=</span>F, t<span style="color: #666666">=</span>t)

<span style="color: #408080; font-style: italic"># Show u(t) as a curve plot</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">matplotlib.pyplot</span> <span style="color: #008000; font-weight: bold">as</span> <span style="color: #0000FF; font-weight: bold">plt</span>
plt<span style="color: #666666">.</span>plot(t, u)
plt<span style="color: #666666">.</span>show()
</pre></div>
<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2 id="___sec13">Local vs global variables </h2>

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">f</span>(u):
    <span style="color: #008000; font-weight: bold">return</span> k<span style="color: #666666">*</span>u
</pre></div>
<p>
Here,

<ul>
  <li> <code>u</code> is a <em>local variable</em>,
    which is accessible just inside in the function</li>
  <li> <code>k</code> is a <em>global variable</em>, which must be initialized outside
    the function prior to calling <code>f</code></li>
</ul>

<!-- !split --><br><br><br><br><br><br><br><br>

<h2 id="___sec14">Advanced programming of functions with parameters </h2>

<ul>
 <li> \( f(u)=ku \) needs parameter \( k \)</li>
 <li> Implement \( f \) as a class with \( k \) as attribute and <code>__call__</code>
   for evaluating <code>f(u)</code></li>
</ul>

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">Spring</span>:
    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">__init__</span>(<span style="color: #008000">self</span>, k):
        <span style="color: #008000">self</span><span style="color: #666666">.</span>k <span style="color: #666666">=</span> k
    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">__call__</span>(<span style="color: #008000">self</span>, u):
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>k<span style="color: #666666">*</span>u

f <span style="color: #666666">=</span> Spring(k)
</pre></div>
<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2 id="___sec15">The excitation force </h2>

<ul>
 <li> Bumpy road gives an excitation</li>
 <li> <a href="http://hplbit.bitbucket.org/data/bumpy/bumpy.dat.gz" target="_blank"><tt>http://hplbit.bitbucket.org/data/bumpy/bumpy.dat.gz</tt></a></li>
 <li> File contains various road profiles</li>
</ul>

Download road profile data from the Internet:

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">filename <span style="color: #666666">=</span> <span style="color: #BA2121">&#39;bumpy.dat.gz&#39;</span>
url <span style="color: #666666">=</span> <span style="color: #BA2121">&#39;http://hplbit.bitbucket.org/data/bumpy/bumpy.dat.gz&#39;</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">urllib</span>
urllib<span style="color: #666666">.</span>urlretrieve(url, filename)
h_data <span style="color: #666666">=</span> np<span style="color: #666666">.</span>loadtxt(filename)     <span style="color: #408080; font-style: italic"># read numpy array from file</span>

x <span style="color: #666666">=</span> h_data[<span style="color: #666666">0</span>,:]                <span style="color: #408080; font-style: italic"># 1st column: x coordinates</span>
h_data <span style="color: #666666">=</span> h_data[<span style="color: #666666">1</span>:,:]          <span style="color: #408080; font-style: italic"># other columns: h shapes</span>
</pre></div>
<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2 id="___sec16">Computing the force from the road profile </h2>

$$ F(t) \sim  h''(t) $$


<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">acceleration</span>(h, x, v):
    <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Compute 2nd-order derivative of h.&quot;&quot;&quot;</span>
    <span style="color: #408080; font-style: italic"># Method: standard finite difference aproximation</span>
    d2h <span style="color: #666666">=</span> np<span style="color: #666666">.</span>zeros(h<span style="color: #666666">.</span>size)
    dx <span style="color: #666666">=</span> x[<span style="color: #666666">1</span>] <span style="color: #666666">-</span> x[<span style="color: #666666">0</span>]
    <span style="color: #008000; font-weight: bold">for</span> i <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">range</span>(<span style="color: #666666">1</span>, h<span style="color: #666666">.</span>size<span style="color: #666666">-1</span>, <span style="color: #666666">1</span>):
        d2h[i] <span style="color: #666666">=</span> (h[i<span style="color: #666666">-1</span>] <span style="color: #666666">-</span> <span style="color: #666666">2*</span>h[i] <span style="color: #666666">+</span> h[i<span style="color: #666666">+1</span>])<span style="color: #666666">/</span>dx<span style="color: #666666">**2</span>
    <span style="color: #408080; font-style: italic"># Extraplolate end values from first interior value</span>
    d2h[<span style="color: #666666">0</span>] <span style="color: #666666">=</span> d2h[<span style="color: #666666">1</span>]
    d2h[<span style="color: #666666">-1</span>] <span style="color: #666666">=</span> d2h[<span style="color: #666666">-2</span>]
    a <span style="color: #666666">=</span> d2h<span style="color: #666666">*</span>v<span style="color: #666666">**2</span>
    <span style="color: #008000; font-weight: bold">return</span> a
</pre></div>
<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2 id="___sec17">Vectorized version of the previous function </h2>

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">acceleration_vectorized</span>(h, x, v):
    <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Compute 2nd-order derivative of h. Vectorized version.&quot;&quot;&quot;</span>
    d2h <span style="color: #666666">=</span> np<span style="color: #666666">.</span>zeros(h<span style="color: #666666">.</span>size)
    dx <span style="color: #666666">=</span> x[<span style="color: #666666">1</span>] <span style="color: #666666">-</span> x[<span style="color: #666666">0</span>]
    d2h[<span style="color: #666666">1</span>:<span style="color: #666666">-1</span>] <span style="color: #666666">=</span> (h[:<span style="color: #666666">-2</span>] <span style="color: #666666">-</span> <span style="color: #666666">2*</span>h[<span style="color: #666666">1</span>:<span style="color: #666666">-1</span>] <span style="color: #666666">+</span> h[<span style="color: #666666">2</span>:])<span style="color: #666666">/</span>dx<span style="color: #666666">**2</span>
    <span style="color: #408080; font-style: italic"># Extraplolate end values from first interior value</span>
    d2h[<span style="color: #666666">0</span>] <span style="color: #666666">=</span> d2h[<span style="color: #666666">1</span>]
    d2h[<span style="color: #666666">-1</span>] <span style="color: #666666">=</span> d2h[<span style="color: #666666">-2</span>]
    a <span style="color: #666666">=</span> d2h<span style="color: #666666">*</span>v<span style="color: #666666">**2</span>
    <span style="color: #008000; font-weight: bold">return</span> a
</pre></div>
<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2 id="___sec18">Performing the simulation of vibrations </h2>

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">data <span style="color: #666666">=</span> [x, t]      <span style="color: #408080; font-style: italic"># key input and output data (arrays)</span>
<span style="color: #008000; font-weight: bold">for</span> i <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">range</span>(h_data<span style="color: #666666">.</span>shape[<span style="color: #666666">0</span>]):
    h <span style="color: #666666">=</span> h_data[i,:]            <span style="color: #408080; font-style: italic"># extract a column</span>
    a <span style="color: #666666">=</span> acceleration(h, x, v)
    u <span style="color: #666666">=</span> forced_vibrations(t<span style="color: #666666">=</span>t, I<span style="color: #666666">=0</span>, m<span style="color: #666666">=</span>m, b<span style="color: #666666">=</span>b, f<span style="color: #666666">=</span>f, F<span style="color: #666666">=-</span>m<span style="color: #666666">*</span>a)
    data<span style="color: #666666">.</span>append([h, a, u])
</pre></div>
<p>
Parameters for bicycle conditions: \( m=60 \) kg, \( v=5 \) m/s, \( k=60 \) N/m,
\( b=80 \) Ns/m

<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2 id="___sec19">A high-level solve function (part I) </h2>

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">solve</span>(url<span style="color: #666666">=</span><span style="color: #008000">None</span>, m<span style="color: #666666">=60</span>, b<span style="color: #666666">=80</span>, k<span style="color: #666666">=60</span>, v<span style="color: #666666">=5</span>):
    <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;</span>
<span style="color: #BA2121; font-style: italic">    Solve model for verticle vehicle vibrations.</span>

<span style="color: #BA2121; font-style: italic">    =========   ==============================================</span>
<span style="color: #BA2121; font-style: italic">    variable    description</span>
<span style="color: #BA2121; font-style: italic">    =========   ==============================================</span>
<span style="color: #BA2121; font-style: italic">    url         either URL of file with excitation force data,</span>
<span style="color: #BA2121; font-style: italic">                or name of a local file</span>
<span style="color: #BA2121; font-style: italic">    m           mass of system</span>
<span style="color: #BA2121; font-style: italic">    b           friction parameter</span>
<span style="color: #BA2121; font-style: italic">    k           spring parameter</span>
<span style="color: #BA2121; font-style: italic">    v           (constant) velocity of vehicle</span>
<span style="color: #BA2121; font-style: italic">    Return      data (list) holding input and output data</span>
<span style="color: #BA2121; font-style: italic">                [x, t, [h,a,u], [h,a,u], ...]</span>
<span style="color: #BA2121; font-style: italic">    =========   ==============================================</span>
<span style="color: #BA2121; font-style: italic">    &quot;&quot;&quot;</span>
    <span style="color: #408080; font-style: italic"># Download file (if url is not the name of a local file)</span>
    <span style="color: #008000; font-weight: bold">if</span> url<span style="color: #666666">.</span>startswith(<span style="color: #BA2121">&#39;http://&#39;</span>) <span style="color: #AA22FF; font-weight: bold">or</span> url<span style="color: #666666">.</span>startswith(<span style="color: #BA2121">&#39;file://&#39;</span>):
        <span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">urllib</span>
        filename <span style="color: #666666">=</span> os<span style="color: #666666">.</span>path<span style="color: #666666">.</span>basename(url)  <span style="color: #408080; font-style: italic"># strip off path</span>
        urllib<span style="color: #666666">.</span>urlretrieve(url, filename)
    <span style="color: #008000; font-weight: bold">else</span>:
        <span style="color: #408080; font-style: italic"># Check if url is the name of a local file</span>
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> os<span style="color: #666666">.</span>path<span style="color: #666666">.</span>isfile(url):
            <span style="color: #008000; font-weight: bold">print</span> url, <span style="color: #BA2121">&#39;must be a URL or a filename&#39;</span>; sys<span style="color: #666666">.</span>exit(<span style="color: #666666">1</span>)
</pre></div>
<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2 id="___sec20">A high-level solve function (part II) </h2>

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">solve</span>(url<span style="color: #666666">=</span><span style="color: #008000">None</span>, m<span style="color: #666666">=60</span>, b<span style="color: #666666">=80</span>, k<span style="color: #666666">=60</span>, v<span style="color: #666666">=5</span>):
    <span style="color: #666666">...</span>
    h_data <span style="color: #666666">=</span> np<span style="color: #666666">.</span>loadtxt(filename)  <span style="color: #408080; font-style: italic"># read numpy array from file</span>

    x <span style="color: #666666">=</span> h_data[<span style="color: #666666">0</span>,:]                <span style="color: #408080; font-style: italic"># 1st column: x coordinates</span>
    h_data <span style="color: #666666">=</span> h_data[<span style="color: #666666">1</span>:,:]          <span style="color: #408080; font-style: italic"># other columns: h shapes</span>

    t <span style="color: #666666">=</span> x<span style="color: #666666">/</span>v                        <span style="color: #408080; font-style: italic"># time corresponding to x</span>
    dt <span style="color: #666666">=</span> t[<span style="color: #666666">1</span>] <span style="color: #666666">-</span> t[<span style="color: #666666">0</span>]

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">f</span>(u):
        <span style="color: #008000; font-weight: bold">return</span> k<span style="color: #666666">*</span>u

    data <span style="color: #666666">=</span> [x, t]      <span style="color: #408080; font-style: italic"># key input and output data (arrays)</span>
    <span style="color: #008000; font-weight: bold">for</span> i <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">range</span>(h_data<span style="color: #666666">.</span>shape[<span style="color: #666666">0</span>]):
        h <span style="color: #666666">=</span> h_data[i,:]            <span style="color: #408080; font-style: italic"># extract a column</span>
        a <span style="color: #666666">=</span> acceleration(h, x, v)

        u <span style="color: #666666">=</span> forced_vibrations(t<span style="color: #666666">=</span>t, I<span style="color: #666666">=0.2</span>, m<span style="color: #666666">=</span>m, b<span style="color: #666666">=</span>b, f<span style="color: #666666">=</span>f, F<span style="color: #666666">=-</span>m<span style="color: #666666">*</span>a)
        data<span style="color: #666666">.</span>append([h, a, u])
    <span style="color: #008000; font-weight: bold">return</span> data
</pre></div>
<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2 id="___sec21">Computing an expression for the noise level of the vibrations </h2>

$$ \mbox{RMS} = \sqrt{\int_0^T u^2dt} \approx \sqrt{\frac{1}{N+1}\sum_{i=0}^N (u^n)^2}$$


<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">rms</span>(data):
    u_rms <span style="color: #666666">=</span> np<span style="color: #666666">.</span>zeros(t<span style="color: #666666">.</span>size)  <span style="color: #408080; font-style: italic"># for accumulating the rms value</span>
    <span style="color: #008000; font-weight: bold">for</span> h, a, u <span style="color: #AA22FF; font-weight: bold">in</span> data[<span style="color: #666666">2</span>:]:  <span style="color: #408080; font-style: italic"># loop over results</span>
        u_rms <span style="color: #666666">+=</span> u<span style="color: #666666">**2</span>
    u_rms <span style="color: #666666">=</span> np<span style="color: #666666">.</span>sqrt(u_rms<span style="color: #666666">/</span>u_rms<span style="color: #666666">.</span>size)
    data<span style="color: #666666">.</span>append(u_rms)
    <span style="color: #008000; font-weight: bold">return</span> data
</pre></div>
<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2 id="___sec22">Pickling objects to file </h2>

<p>
After calling

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">road_url <span style="color: #666666">=</span> <span style="color: #BA2121">&#39;http://hplbit.bitbucket.org/data/bumpy/bumpy.dat.gz&#39;</span>
data <span style="color: #666666">=</span> solve(url<span style="color: #666666">=</span>road_url,
             m<span style="color: #666666">=60</span>, b<span style="color: #666666">=200</span>, k<span style="color: #666666">=60</span>, v<span style="color: #666666">=6</span>)
data <span style="color: #666666">=</span> rms(data)
</pre></div>
<p>
the <code>data</code> array contains single arrays and triplets of arrays,

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">[x, t, [h,a,u], [h,a,u], <span style="color: #666666">...</span>, [h,a,u], u_rms]
</pre></div>
<p>
This list, or any Python object, can be stored on file for later
retrieval of the results, using <em>pickling</em>:

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">cPickle</span>
outfile <span style="color: #666666">=</span> <span style="color: #008000">open</span>(<span style="color: #BA2121">&#39;bumpy.res&#39;</span>, <span style="color: #BA2121">&#39;w&#39;</span>)
cPickle<span style="color: #666666">.</span>dump(data, outfile)
outfile<span style="color: #666666">.</span>close()
</pre></div>
<p>
See <a href="https://github.com/hplgit/bumpy/blob/master/doc/src/src-bumpy/bumpy.py" target="_blank"><tt>bumpy.py</tt></a>.

<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h1 id="___sec23">User input </h1>

<p>
<center><p><img src="fig-bumpy/input2.jpg" align="bottom" width=500></p></center>

<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2 id="___sec24">Positional command-line arguments </h2>

<p>
Suppose \( b \) is given on the command line:

<p>

<!-- code=text (!bc sys) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">Terminal&gt; python bumpy.py 10
</pre></div>
<p>
Code:

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">try</span>:
    b <span style="color: #666666">=</span> <span style="color: #008000">float</span>(sys<span style="color: #666666">.</span>argv[<span style="color: #666666">1</span>])
<span style="color: #008000; font-weight: bold">except</span> <span style="color: #D2413A; font-weight: bold">IndexError</span>:
    b <span style="color: #666666">=</span> <span style="color: #666666">80</span>  <span style="color: #408080; font-style: italic"># default</span>
</pre></div>
<p>
Note: 1st command-line argument in <code>sys.argv[1]</code>, but that is a string

<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2 id="___sec25">Option-value pairs on the command line </h2>

<p>
Now we want to use option-value pairs on the command line:

<p>

<!-- code=text (!bc sys) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">Terminal&gt; python bumpy.py --m 40 --b 280
</pre></div>
<p>
Note:

<ul>
 <li> All parameters have default values</li>
 <li> The default value can be overridden on the command line with
   <code>--option value</code></li>
 <li> We use the <code>argparse</code> module for defining, reading, and accessing
   option-value pairs</li>
</ul>

<!-- !split --><br><br><br><br><br><br><br><br>

<h2 id="___sec26">Example on using <code>argparse</code> </h2>

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">command_line_options</span>():
    <span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">argparse</span>
    parser <span style="color: #666666">=</span> argparse<span style="color: #666666">.</span>ArgumentParser()
    parser<span style="color: #666666">.</span>add_argument(<span style="color: #BA2121">&#39;--m&#39;</span>, <span style="color: #BA2121">&#39;--mass&#39;</span>, <span style="color: #008000">type</span><span style="color: #666666">=</span><span style="color: #008000">float</span>,
                        default<span style="color: #666666">=60</span>, help<span style="color: #666666">=</span><span style="color: #BA2121">&#39;mass of vehicle&#39;</span>)
    parser<span style="color: #666666">.</span>add_argument(<span style="color: #BA2121">&#39;--k&#39;</span>, <span style="color: #BA2121">&#39;--spring&#39;</span>, <span style="color: #008000">type</span><span style="color: #666666">=</span><span style="color: #008000">float</span>,
                        default<span style="color: #666666">=60</span>, help<span style="color: #666666">=</span><span style="color: #BA2121">&#39;spring parameter&#39;</span>)
    parser<span style="color: #666666">.</span>add_argument(<span style="color: #BA2121">&#39;--b&#39;</span>, <span style="color: #BA2121">&#39;--damping&#39;</span>, <span style="color: #008000">type</span><span style="color: #666666">=</span><span style="color: #008000">float</span>,
                        default<span style="color: #666666">=80</span>, help<span style="color: #666666">=</span><span style="color: #BA2121">&#39;damping parameter&#39;</span>)
    parser<span style="color: #666666">.</span>add_argument(<span style="color: #BA2121">&#39;--v&#39;</span>, <span style="color: #BA2121">&#39;--velocity&#39;</span>, <span style="color: #008000">type</span><span style="color: #666666">=</span><span style="color: #008000">float</span>,
                        default<span style="color: #666666">=5</span>, help<span style="color: #666666">=</span><span style="color: #BA2121">&#39;velocity of vehicle&#39;</span>)
    url <span style="color: #666666">=</span> <span style="color: #BA2121">&#39;http://hplbit.bitbucket.org/data/bumpy/bumpy.dat.gz&#39;</span>
    parser<span style="color: #666666">.</span>add_argument(<span style="color: #BA2121">&#39;--roadfile&#39;</span>, <span style="color: #008000">type</span><span style="color: #666666">=</span><span style="color: #008000">str</span>,
              default<span style="color: #666666">=</span>url, help<span style="color: #666666">=</span><span style="color: #BA2121">&#39;filename/URL with road data&#39;</span>)
    args <span style="color: #666666">=</span> parser<span style="color: #666666">.</span>parse_args()
    <span style="color: #408080; font-style: italic"># Extract input parameters</span>
    m <span style="color: #666666">=</span> args<span style="color: #666666">.</span>m; k <span style="color: #666666">=</span> args<span style="color: #666666">.</span>k; b <span style="color: #666666">=</span> args<span style="color: #666666">.</span>b; v <span style="color: #666666">=</span> args<span style="color: #666666">.</span>v
    url <span style="color: #666666">=</span> args<span style="color: #666666">.</span>roadfile
    <span style="color: #008000; font-weight: bold">return</span> url, m, b, k, v
</pre></div>
<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h1 id="___sec27">Visual exploration </h1>

<p>
Plot

<ul>
 <li> the root mean square value of \( u(t) \), to see the typical amplitudes</li>
 <li> the spectrum of \( u(t) \), for \( t>t_s \) (using FFT) to see which frequencies
   that dominate in the signal</li>
 <li> for each road shape, a plot of \( h(x) \), \( a(t) \), and \( u(t) \), for
   \( t\geq t_s \)</li>
</ul>

<!-- !split --><br><br><br><br><br><br><br><br>

<h2 id="___sec28">Code (part I) </h2>

<p>
For convenience:

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">numpy</span> <span style="color: #008000; font-weight: bold">import</span> <span style="color: #666666">*</span>
<span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">matplotlib.pyplot</span> <span style="color: #008000; font-weight: bold">import</span> <span style="color: #666666">*</span>
</pre></div>
<p>
Loading results from file:

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">cPickle</span>
outfile <span style="color: #666666">=</span> <span style="color: #008000">open</span>(<span style="color: #BA2121">&#39;bumpy.res&#39;</span>, <span style="color: #BA2121">&#39;r&#39;</span>)
data <span style="color: #666666">=</span> cPickle<span style="color: #666666">.</span>load(outfile)
outfile<span style="color: #666666">.</span>close()

x, t <span style="color: #666666">=</span> data[<span style="color: #666666">0</span>:<span style="color: #666666">2</span>]
u_rms <span style="color: #666666">=</span> data[<span style="color: #666666">-1</span>]
</pre></div>
<p>
Recall list <code>data</code>:

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">[x, t, [h,a,u], [h,a,u], <span style="color: #666666">...</span>, [h,a,u], u_rms]
</pre></div>
<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2 id="___sec29">Code (part II) </h2>

<p>
Display only the last portion of time series:

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">indices <span style="color: #666666">=</span> t <span style="color: #666666">&gt;=</span> t_s   <span style="color: #408080; font-style: italic"># True/False boolean array</span>
t <span style="color: #666666">=</span> t[indices]       <span style="color: #408080; font-style: italic"># fetch the part of t for which t &gt; t_s</span>
x <span style="color: #666666">=</span> x[indices]       <span style="color: #408080; font-style: italic"># fetch the part of x for which t &gt; t_s</span>
</pre></div>
<p>
Plotting the root mean square value array <code>u_rms</code> for <code>t &gt;= t_s</code> is now done by

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">figure()
u_rms <span style="color: #666666">=</span> u_rms[indices]
plot(t, u_rms)
legend([<span style="color: #BA2121">&#39;u&#39;</span>])
xlabel(<span style="color: #BA2121">&#39;t&#39;</span>)
title(<span style="color: #BA2121">&#39;Root mean square value of u(t) functions&#39;</span>)
show()
</pre></div>
<p>
<center><p><img src="fig-bumpy/u_rms.png" align="bottom" width=300></p></center>

<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2 id="___sec30">Code (part III) </h2>

<p>
The spectrum of a discrete function \( u(t) \):

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">frequency_analysis</span>(u, t):
    A <span style="color: #666666">=</span> fft(u)
    A <span style="color: #666666">=</span> <span style="color: #666666">2*</span>A
    dt <span style="color: #666666">=</span> t[<span style="color: #666666">1</span>] <span style="color: #666666">-</span> t[<span style="color: #666666">0</span>]
    N <span style="color: #666666">=</span> t<span style="color: #666666">.</span>size
    freq <span style="color: #666666">=</span> arange(N<span style="color: #666666">/2</span>, dtype<span style="color: #666666">=</span><span style="color: #008000">float</span>)<span style="color: #666666">/</span>N<span style="color: #666666">/</span>dt
    A <span style="color: #666666">=</span> <span style="color: #008000">abs</span>(A[<span style="color: #666666">0</span>:freq<span style="color: #666666">.</span>size])<span style="color: #666666">/</span>N
    <span style="color: #408080; font-style: italic"># Remove small high frequency part</span>
    tol <span style="color: #666666">=</span> <span style="color: #666666">0.05*</span>A<span style="color: #666666">.</span>max()
    <span style="color: #008000; font-weight: bold">for</span> i <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">xrange</span>(<span style="color: #008000">len</span>(A)<span style="color: #666666">-1</span>, <span style="color: #666666">0</span>, <span style="color: #666666">-1</span>):
        <span style="color: #008000; font-weight: bold">if</span> A[i] <span style="color: #666666">&gt;</span> tol:
            <span style="color: #008000; font-weight: bold">break</span>
    <span style="color: #008000; font-weight: bold">return</span> freq[:i<span style="color: #666666">+1</span>], A[:i<span style="color: #666666">+1</span>]

figure()
u <span style="color: #666666">=</span> data[<span style="color: #666666">3</span>][<span style="color: #666666">2</span>][indices]  <span style="color: #408080; font-style: italic"># 2nd realization of u</span>
f, A <span style="color: #666666">=</span> frequency_analysis(u, t)
plot(f, A)
title(<span style="color: #BA2121">&#39;Spectrum of u&#39;</span>)
show()
</pre></div>
<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2 id="___sec31">Plot of the spectrum </h2>

<p>
<center><p><img src="fig-bumpy/u_spectrum.png" align="bottom" width=600></p></center>

<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2 id="___sec32">Code (part IV) </h2>

<p>
Run through all the 3-lists <code>[h, a, u]</code> and plot
these arrays:

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">case_counter <span style="color: #666666">=</span> <span style="color: #666666">0</span>
<span style="color: #008000; font-weight: bold">for</span> h, a, u <span style="color: #AA22FF; font-weight: bold">in</span> data[<span style="color: #666666">2</span>:<span style="color: #666666">-1</span>]:
    h <span style="color: #666666">=</span> h[indices]
    a <span style="color: #666666">=</span> a[indices]
    u <span style="color: #666666">=</span> u[indices]

    figure()
    subplot(<span style="color: #666666">3</span>, <span style="color: #666666">1</span>, <span style="color: #666666">1</span>)
    plot(x, h, <span style="color: #BA2121">&#39;g-&#39;</span>)
    legend([<span style="color: #BA2121">&#39;h </span><span style="color: #BB6688; font-weight: bold">%d</span><span style="color: #BA2121">&#39;</span> <span style="color: #666666">%</span> case_counter])
    hmax <span style="color: #666666">=</span> (<span style="color: #008000">abs</span>(h<span style="color: #666666">.</span>max()) <span style="color: #666666">+</span> <span style="color: #008000">abs</span>(h<span style="color: #666666">.</span>min()))<span style="color: #666666">/2</span>
    axis([x[<span style="color: #666666">0</span>], x[<span style="color: #666666">-1</span>], <span style="color: #666666">-</span>hmax<span style="color: #666666">*5</span>, hmax<span style="color: #666666">*5</span>])
    xlabel(<span style="color: #BA2121">&#39;distance&#39;</span>); ylabel(<span style="color: #BA2121">&#39;height&#39;</span>)

    subplot(<span style="color: #666666">3</span>, <span style="color: #666666">1</span>, <span style="color: #666666">2</span>)
    plot(t, a)
    legend([<span style="color: #BA2121">&#39;a </span><span style="color: #BB6688; font-weight: bold">%d</span><span style="color: #BA2121">&#39;</span> <span style="color: #666666">%</span> case_counter])
    xlabel(<span style="color: #BA2121">&#39;t&#39;</span>); ylabel(<span style="color: #BA2121">&#39;acceleration&#39;</span>)

    subplot(<span style="color: #666666">3</span>, <span style="color: #666666">1</span>, <span style="color: #666666">3</span>)
    plot(t, u, <span style="color: #BA2121">&#39;r-&#39;</span>)
    legend([<span style="color: #BA2121">&#39;u </span><span style="color: #BB6688; font-weight: bold">%d</span><span style="color: #BA2121">&#39;</span> <span style="color: #666666">%</span> case_counter])
    xlabel(<span style="color: #BA2121">&#39;t&#39;</span>); ylabel(<span style="color: #BA2121">&#39;displacement&#39;</span>)
    savefig(<span style="color: #BA2121">&#39;tmp</span><span style="color: #BB6688; font-weight: bold">%d</span><span style="color: #BA2121">.png&#39;</span> <span style="color: #666666">%</span> case_counter)
    case_counter <span style="color: #666666">+=</span> <span style="color: #666666">1</span>
</pre></div>
<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2 id="___sec33">Plot </h2>

<p>
<center><p><img src="fig-bumpy/hau0.png" align="bottom" width=700></p></center>

<p>
See <a href="https://github.com/hplgit/bumpy/blob/master/doc/src/src-bumpy/explore.py" target="_blank"><tt>explore.py</tt></a>

<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h1 id="___sec34">Advanced topics </h1>

<p>
<center><p><img src="fig-bumpy/rocket_science1.gif" align="bottom" width=400></p></center>

<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2 id="___sec35">Symbolic computing via SymPy </h2>

<p>

<!-- code=python (!bc pyshell) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #666666">&gt;&gt;&gt;</span> <span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">sympy</span> <span style="color: #008000; font-weight: bold">as</span> <span style="color: #0000FF; font-weight: bold">sp</span>
<span style="color: #666666">&gt;&gt;&gt;</span> x, a <span style="color: #666666">=</span> sp<span style="color: #666666">.</span>symbols(<span style="color: #BA2121">&#39;x a&#39;</span>)        <span style="color: #408080; font-style: italic"># Define mathematical symbols</span>
<span style="color: #666666">&gt;&gt;&gt;</span> Q <span style="color: #666666">=</span> a<span style="color: #666666">*</span>x<span style="color: #666666">**2</span> <span style="color: #666666">-</span> <span style="color: #666666">1</span>                  <span style="color: #408080; font-style: italic"># Quadratic function</span>
<span style="color: #666666">&gt;&gt;&gt;</span> dQdx <span style="color: #666666">=</span> sp<span style="color: #666666">.</span>diff(Q, x)            <span style="color: #408080; font-style: italic"># Differentiate wrt x</span>
<span style="color: #666666">&gt;&gt;&gt;</span> dQdx
<span style="color: #666666">2*</span>a<span style="color: #666666">*</span>x
<span style="color: #666666">&gt;&gt;&gt;</span> Q2 <span style="color: #666666">=</span> sp<span style="color: #666666">.</span>integrate(dQdx, x)      <span style="color: #408080; font-style: italic"># Integrate (no constant)</span>
<span style="color: #666666">&gt;&gt;&gt;</span> Q2
a<span style="color: #666666">*</span>x<span style="color: #666666">**2</span>
<span style="color: #666666">&gt;&gt;&gt;</span> Q2 <span style="color: #666666">=</span> sp<span style="color: #666666">.</span>integrate(Q, (x, <span style="color: #666666">0</span>, a)) <span style="color: #408080; font-style: italic"># Definite integral</span>
<span style="color: #666666">&gt;&gt;&gt;</span> Q2
a<span style="color: #666666">**4/3</span> <span style="color: #666666">-</span> a
<span style="color: #666666">&gt;&gt;&gt;</span> roots <span style="color: #666666">=</span> sp<span style="color: #666666">.</span>solve(Q, x)          <span style="color: #408080; font-style: italic"># Solve Q = 0 wrt x</span>
<span style="color: #666666">&gt;&gt;&gt;</span> roots
[<span style="color: #666666">-</span>sqrt(<span style="color: #666666">1/</span>a), sqrt(<span style="color: #666666">1/</span>a)]
</pre></div>
<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2 id="___sec36">Go seamlessly from symbolic expression to Python function </h2>

<p>
Convert a SymPy expression <code>Q</code> into
a Python function <code>Q(x, a)</code>:

<p>

<!-- code=python (!bc pyshell) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #666666">&gt;&gt;&gt;</span> Q <span style="color: #666666">=</span> sp<span style="color: #666666">.</span>lambdify([x, a], Q)      <span style="color: #408080; font-style: italic"># Turn Q into Py func.</span>
<span style="color: #666666">&gt;&gt;&gt;</span> Q(x<span style="color: #666666">=2</span>, a<span style="color: #666666">=3</span>)                     <span style="color: #408080; font-style: italic"># 3*2**2 - 1 = 11</span>
<span style="color: #666666">11</span>
</pre></div>
<p>
This <code>Q(x, a)</code> function can be used for numerical computing

<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2 id="___sec37">Testing via test functions and test frameworks </h2>

<p>
Modern test frameworks:

<ul>
 <li> <a href="https://nose.readthedocs.org/" target="_blank">nose</a></li>
 <li> <a href="http://pytest.org/latest/" target="_blank">pytest</a></li>
</ul>

Recommendation: use pytest, stay away from <code>unittest</code>

<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2 id="___sec38">Example on a test function </h2>

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">halve</span>(x):
    <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Return half of x.&quot;&quot;&quot;</span>
    <span style="color: #008000; font-weight: bold">return</span> x<span style="color: #666666">/2.0</span>

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">test_halve</span>():
    x <span style="color: #666666">=</span> <span style="color: #666666">4</span>
    expected <span style="color: #666666">=</span> <span style="color: #666666">2</span>
    computed <span style="color: #666666">=</span> halve(x)
    <span style="color: #408080; font-style: italic"># Compare real numbers using tolerance</span>
    tol <span style="color: #666666">=</span> <span style="color: #666666">1E-14</span>
    diff <span style="color: #666666">=</span> <span style="color: #008000">abs</span>(computed <span style="color: #666666">-</span> expected)
    <span style="color: #008000; font-weight: bold">assert</span> diff <span style="color: #666666">&lt;</span> tol
</pre></div>
<p>
Note:

<ul>
 <li> Name starts with <code>test_*</code></li>
 <li> No arguments</li>
 <li> Must have <code>assert</code> on a boolean expression for passed test</li>
</ul>

<!-- !split --><br><br><br><br><br><br><br><br>

<h2 id="___sec39">Test function for the numerical solver (part I) </h2>

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">lhs_eq</span>(t, m, b, s, u, damping<span style="color: #666666">=</span><span style="color: #BA2121">&#39;linear&#39;</span>):
    <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Return lhs of differential equation as sympy expression.&quot;&quot;&quot;</span>
    v <span style="color: #666666">=</span> sm<span style="color: #666666">.</span>diff(u, t)
    d <span style="color: #666666">=</span> b<span style="color: #666666">*</span>v <span style="color: #008000; font-weight: bold">if</span> damping <span style="color: #666666">==</span> <span style="color: #BA2121">&#39;linear&#39;</span> <span style="color: #008000; font-weight: bold">else</span> b<span style="color: #666666">*</span>v<span style="color: #666666">*</span>sm<span style="color: #666666">.</span>Abs(v)
    <span style="color: #008000; font-weight: bold">return</span> m<span style="color: #666666">*</span>sm<span style="color: #666666">.</span>diff(u, t, t) <span style="color: #666666">+</span> d <span style="color: #666666">+</span> s(u)

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">test_solver</span>():
    <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Verify linear/quadratic solution.&quot;&quot;&quot;</span>
    <span style="color: #408080; font-style: italic"># Set input data for the test</span>
    I <span style="color: #666666">=</span> <span style="color: #666666">1.2</span>; V <span style="color: #666666">=</span> <span style="color: #666666">3</span>; m <span style="color: #666666">=</span> <span style="color: #666666">2</span>; b <span style="color: #666666">=</span> <span style="color: #666666">0.9</span>; k <span style="color: #666666">=</span> <span style="color: #666666">4</span>
    s <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">lambda</span> u: k<span style="color: #666666">*</span>u
    T <span style="color: #666666">=</span> <span style="color: #666666">2</span>
    dt <span style="color: #666666">=</span> <span style="color: #666666">0.2</span>
    N <span style="color: #666666">=</span> <span style="color: #008000">int</span>(<span style="color: #008000">round</span>(T<span style="color: #666666">/</span>dt))
    time_points <span style="color: #666666">=</span> np<span style="color: #666666">.</span>linspace(<span style="color: #666666">0</span>, T, N<span style="color: #666666">+1</span>)

    <span style="color: #408080; font-style: italic"># Test linear damping</span>
    t <span style="color: #666666">=</span> sm<span style="color: #666666">.</span>Symbol(<span style="color: #BA2121">&#39;t&#39;</span>)
    q <span style="color: #666666">=</span> <span style="color: #666666">2</span>  <span style="color: #408080; font-style: italic"># arbitrary constant</span>
    u_exact <span style="color: #666666">=</span> I <span style="color: #666666">+</span> V<span style="color: #666666">*</span>t <span style="color: #666666">+</span> q<span style="color: #666666">*</span>t<span style="color: #666666">**2</span>   <span style="color: #408080; font-style: italic"># sympy expression</span>
    F_term <span style="color: #666666">=</span> lhs_eq(t, m, b, s, u_exact, <span style="color: #BA2121">&#39;linear&#39;</span>)
    <span style="color: #008000; font-weight: bold">print</span> <span style="color: #BA2121">&#39;Fitted source term, linear case:&#39;</span>, F_term
    F <span style="color: #666666">=</span> sm<span style="color: #666666">.</span>lambdify([t], F_term)
    u, t_ <span style="color: #666666">=</span> solver(I, V, m, b, s, F, time_points, <span style="color: #BA2121">&#39;linear&#39;</span>)
    u_e <span style="color: #666666">=</span> sm<span style="color: #666666">.</span>lambdify([t], u_exact, modules<span style="color: #666666">=</span><span style="color: #BA2121">&#39;numpy&#39;</span>)
    error <span style="color: #666666">=</span> <span style="color: #008000">abs</span>(u_e(t_) <span style="color: #666666">-</span> u)<span style="color: #666666">.</span>max()
    tol <span style="color: #666666">=</span> <span style="color: #666666">1E-13</span>
    <span style="color: #008000; font-weight: bold">assert</span> error <span style="color: #666666">&lt;</span> tol
</pre></div>
<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2 id="___sec40">Test function for the numerical solver (part II) </h2>

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">test_solver</span>():
    <span style="color: #666666">...</span>
    <span style="color: #408080; font-style: italic"># Test quadratic damping: u_exact must be linear</span>
    u_exact <span style="color: #666666">=</span> I <span style="color: #666666">+</span> V<span style="color: #666666">*</span>t
    F_term <span style="color: #666666">=</span> lhs_eq(t, m, b, s, u_exact, <span style="color: #BA2121">&#39;quadratic&#39;</span>)
    <span style="color: #008000; font-weight: bold">print</span> <span style="color: #BA2121">&#39;Fitted source term, quadratic case:&#39;</span>, F_term
    F <span style="color: #666666">=</span> sm<span style="color: #666666">.</span>lambdify([t], F_term)
    u, t_ <span style="color: #666666">=</span> solver(I, V, m, b, s, F, time_points, <span style="color: #BA2121">&#39;quadratic&#39;</span>)
    u_e <span style="color: #666666">=</span> sm<span style="color: #666666">.</span>lambdify([t], u_exact, modules<span style="color: #666666">=</span><span style="color: #BA2121">&#39;numpy&#39;</span>)
    error <span style="color: #666666">=</span> <span style="color: #008000">abs</span>(u_e(t_) <span style="color: #666666">-</span> u)<span style="color: #666666">.</span>max()
    <span style="color: #008000; font-weight: bold">assert</span> error <span style="color: #666666">&lt;</span> tol
</pre></div>
<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2 id="___sec41">Using a test framework </h2>

<p>
Examine all subdirectories <code>test*</code> for <code>test_*.py</code> files:

<p>

<!-- code=text (!bc sys) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">Terminal&gt; py.test -s
====================== test session starts =======================
...
collected 3 items

tests/test_bumpy.py .
Fitted source term, linear case: 8*t**2 + 15.6*t + 15.5
Fitted source term, quadratic case: 12*t + 12.9
testing solver
testing solver_linear_damping_wrapper

==================== 3 passed in 0.40 seconds ====================
</pre></div>
<p>
Test a single file:

<p>

<!-- code=text (!bc sys) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">Terminal&gt; py.test -s tests/test_bumpy.py
...
</pre></div>
<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2 id="___sec42">Modules </h2>

<ul>
 <li> Put functions in a file - that is a module</li>
 <li> Move main program to a function</li>
 <li> Use a test block for executable code (call to main function)</li>
</ul>

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">if</span> __name__ <span style="color: #666666">==</span> <span style="color: #BA2121">&#39;__main__&#39;</span>:
    <span style="color: #666666">&lt;</span>statements <span style="color: #AA22FF; font-weight: bold">in</span> the main program<span style="color: #666666">&gt;</span>
</pre></div>
<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2 id="___sec43">Example on a module file </h2>

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">module1</span>
<span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">module2</span> <span style="color: #008000; font-weight: bold">import</span> somefunc1, somefunc2

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">myfunc1</span>(<span style="color: #666666">...</span>):
    <span style="color: #666666">...</span>

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">myfunc2</span>(<span style="color: #666666">...</span>):
    <span style="color: #666666">...</span>

<span style="color: #008000; font-weight: bold">if</span> __name__ <span style="color: #666666">==</span> <span style="color: #BA2121">&#39;__main__&#39;</span>:
    <span style="color: #666666">&lt;</span>statements <span style="color: #AA22FF; font-weight: bold">in</span> the main program<span style="color: #666666">&gt;</span>
</pre></div>
<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2 id="___sec44">What gets imported? </h2>

<p>
Import everything from the previous module:

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">mymod</span> <span style="color: #008000; font-weight: bold">import</span> <span style="color: #666666">*</span>
</pre></div>
<p>
This imports

<ul>
 <li> <code>module1</code>, <code>somefunc1</code>, <code>somefunc2</code> (global names in <code>mymod</code>)</li>
 <li> <code>myfunc1</code>, <code>myfunc2</code> (global functions in <code>mymod</code>)</li>
</ul>


<!-- ------------------- end of main content --------------- -->


</body>
</html>
    

