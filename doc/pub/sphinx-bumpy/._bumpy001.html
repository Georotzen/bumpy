
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>A scientific application</title>
    
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="_static/sidebar.js"></script>

        <script src="http://sagecell.sagemath.org/static/jquery.min.js"></script>
        <script src="http://sagecell.sagemath.org/static/embedded_sagecell.js"></script>

        <script>sagecell.makeSagecell({inputLocation: ".sage"});</script>

        <style type="text/css">
                .sagecell .CodeMirror-scroll {
                        overflow-y: hidden;
                        overflow-x: auto;
                }
                .sagecell .CodeMirror {
                        height: auto;
                }
        </style>

    
    <link rel="top" title="A worked example on scientific computing with Python" href="index.html" />
    <link rel="next" title="User input" href="._bumpy002.html" />
    <link rel="prev" title="A worked example on scientific computing with Python" href="._bumpy000.html" />
 
  
       <style type="text/css">
         div.admonition {
           background-color: whiteSmoke;
           border: 1px solid #bababa;
         }
       </style>
      </head>
    
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="._bumpy002.html" title="User input"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="._bumpy000.html" title="A worked example on scientific computing with Python"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">A worked example on scientific computing with Python</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="a-scientific-application">
<h1>A scientific application<a class="headerlink" href="#a-scientific-application" title="Permalink to this headline">¶</a></h1>
<div class="section" id="physical-problem-and-mathematical-model">
<h2>Physical problem and mathematical model<a class="headerlink" href="#physical-problem-and-mathematical-model" title="Permalink to this headline">¶</a></h2>
<p>The task is to make a simulation program that can predict how a (simple)
mechanical system oscillates in response to environmental forces.
Introducing <span class="math">\(u(t)\)</span> as some displacement of the system at time <span class="math">\(t\)</span>,
application of Newton&#8217;s second law of motion to such a mechanical system often
results in the following type of equation for <span class="math">\(u\)</span>:</p>
<div class="math" id="eq-bumpy-eq1">
\[\tag{1}
mu'' + f(u') + s(u) = F(t),\]</div>
<p>The prime, as in <span class="math">\(u'\)</span>, denotes differentiation with respect to time
(<span class="math">\(u'(t)\)</span> or <span class="math">\(du/dt\)</span>).
Furthermore, <span class="math">\(m\)</span> is the mass of the system, <span class="math">\(f(u')\)</span> is a friction force
that gives rise to a damping of the motion,
<span class="math">\(s(u)\)</span> represents a restoring force, such as
a spring, and <span class="math">\(F(t)\)</span> models the external environmental forces on the system.
Equation <a class="reference internal" href="#eq-bumpy-eq1"><span class="std std-ref">(1)</span></a> must be accompanied by two initial conditions:
<span class="math">\(u(0)=I\)</span> and <span class="math">\(u'(0)=V\)</span>.
The values of these have no effect on the
steady state behavior of <span class="math">\(u(t)\)</span> for large values of <span class="math">\(t\)</span>, since this
behavior is determined by the force <span class="math">\(F(t)\)</span> and the system
parameters <span class="math">\(m\)</span>, <span class="math">\(f(u')\)</span>, and <span class="math">\(s(u)\)</span>.</p>
<p>There are two types of the friction force <span class="math">\(f\)</span>: linear damping <span class="math">\(f(u')=bu'\)</span>
and quadratic damping <span class="math">\(f(u')=bu'|u'|\)</span>.
The input data consists of <span class="math">\(m\)</span>, <span class="math">\(b\)</span>, <span class="math">\(s(u)\)</span>, <span class="math">\(F(t)\)</span>, <span class="math">\(I\)</span>, <span class="math">\(V\)</span>,
and specification of linear or quadratic damping.
The unknown quantity to be computed is <span class="math">\(u(t)\)</span> for <span class="math">\(t\in (0,T]\)</span>.</p>
<p>One example where the model above has relevance, is the vertical
vibration of a vehicle in response to a bumpy road. Let <span class="math">\(h(x)\)</span> be the
height of the road at some coordinate <span class="math">\(x\)</span> along the road.  When
driving along this road with constant velocity <span class="math">\(v\)</span>, the vehicle is
moved up and down in time according to <span class="math">\(h(vt)\)</span>, resulting in an
external vertical force <span class="math">\(F(t)=-mh''(vt)v^2\)</span>. We assume that the
vehicle has springs and dampers that here are modeled as <span class="math">\(bu'\)</span>
(damper) and <span class="math">\(s(s)=ku\)</span> (spring), with given damping parameter <span class="math">\(b\)</span> and
spring constant <span class="math">\(k\)</span>. The unknown <span class="math">\(u(t)\)</span> is the vertical displacement
of the vehicle relative to the road. Figure <a class="reference internal" href="#bumpy-fig1"><span class="std std-ref">Vehicle on a bumpy road</span></a>
illustrates the situation. You may <a class="reference external" href="http://hplgit.github.io/bumpy/doc/src/mov-bumpy/m2_k1_5_b0_2/index.html">view an animation</a> of such a motion
on the web (by the way, this animation was created by coupling the
<a class="reference external" href="https://github.com/hplgit/pysketcher">Pysketcher</a> tool for
figure drawings with the differential equation solver presented later,
see the script <a class="reference external" href="https://github.com/hplgit/bumpy/blob/master/doc/src/fig-bumpy/bumpy_road_fig.py">bumpy_road_fig.py</a> for all details).</p>
<div class="figure" id="id1">
<span id="bumpy-fig1"></span><a class="reference internal image-reference" href="_images/vehicle2.png"><img alt="_images/vehicle2.png" src="_images/vehicle2.png" style="width: 600px;" /></a>
<p class="caption"><span class="caption-text"><em>Vehicle on a bumpy road</em></span></p>
</div>
<p>Another example regards the vertical shaking of a building due to
earthquake-induced movement of the ground. If the vertical displacement of the
ground is recorded as a function <span class="math">\(d(t)\)</span>, this results in a
vertical force <span class="math">\(F(t)=-md''(t)\)</span>. The soil foundation acts as a
spring and damper on the building, modeled through the damping parameter
<span class="math">\(b\)</span> and normally a linear spring term <span class="math">\(s(u)=ku\)</span>.</p>
<p>In both cases we drop the effect of gravity, which is just a constant
compression of the spring.</p>
<p>Our task is to compute and analyze the vertical <span class="math">\(u(t)\)</span> vibrations
of a vehicle, given the shape <span class="math">\(h(x)\)</span> of the road and some velocity <span class="math">\(v\)</span>.</p>
</div>
<div class="section" id="numerical-model">
<h2>Numerical model<a class="headerlink" href="#numerical-model" title="Permalink to this headline">¶</a></h2>
<p>The differential equation problem <a class="reference internal" href="#eq-bumpy-eq1"><span class="std std-ref">(1)</span></a> can be solved
by introducing finite difference approximations for <span class="math">\(u''\)</span> and <span class="math">\(u'\)</span>.
In case of quadratic damping one can use a geometric mean to approximate
<span class="math">\(u'|u'|\)</span> and thereby linearize the equations. The result of using
such numerical methods is an algorithm for computing <span class="math">\(u(t)\)</span> at
discrete points in time. Let <span class="math">\(u^n\)</span> be the approximation to <span class="math">\(u\)</span> at
time <span class="math">\(t_n=n\Delta t\)</span>, <span class="math">\(n=1,2,\ldots\)</span>, where <span class="math">\(\Delta t\)</span>
is a (small) time interval. For example, if <span class="math">\(\Delta t = 0.1\)</span>, we
find approximations <span class="math">\(u^1\)</span> to <span class="math">\(u\)</span> at <span class="math">\(t=0.1\)</span>, <span class="math">\(u^2\)</span> at <span class="math">\(t=0.2\)</span>, <span class="math">\(u^3\)</span>
to <span class="math">\(t=0.3\)</span>, and so forth. Any value <span class="math">\(u^{n+1}\)</span> can be computed if <span class="math">\(u^n\)</span>
and <span class="math">\(u^{n-1}\)</span> are known (i.e., previously computed).
The formula for <span class="math">\(u^{n+1}\)</span> is, in case of linear damping <span class="math">\(f(u')=bu'\)</span>,</p>
<div class="math" id="eq-bumpy-u-scheme-lin">
\[\tag{2}
u^{n+1} = \left(2mu^n + (\frac{b}{2}\Delta t - m)u^{n-1} +
    \Delta t^2(F^n - s(u^n))
    \right)(m + \frac{b}{2}\Delta t)^{-1},\]</div>
<p>where <span class="math">\(F^n\)</span> means <span class="math">\(F(t)\)</span> evaluated for <span class="math">\(t=t_n\)</span>. A special formula
must be applied for <span class="math">\(n=0\)</span>:</p>
<div class="math" id="eq-bumpy-u-scheme0-lin">
\[\tag{3}
u^1 = u^0 + \Delta t\, V
    + \frac{\Delta t^2}{2m}(-bV - s(u^0) + F^0)
    \thinspace .\]</div>
<p>For quadratic damping we have a slightly different formula,</p>
<div class="math">
\[u^{n+1} =  \left( m + b|u^n-u^{n-1}|\right)^{-1}\times\nonumber\]</div>
<div class="math" id="eq-bumpy-u-scheme-quad">
\[\tag{4}
\quad \left(2m u^n - mu^{n-1} + bu^n|u^n-u^{n-1}| + \Delta t^2 (F^n - s(u^n))
    \right),\]</div>
<p>and again a special formula for <span class="math">\(u^1\)</span>:</p>
<div class="math" id="eq-bumpy-u-scheme0-quad">
\[\tag{5}
u^1 = u^0 + \Delta t V + \frac{\Delta t^2}{2m}\left(-bV|V| - s(u^0) + F^0\right)
    \thinspace .\]</div>
<p>The implementation of the computational algorithm can make use
of an array <code class="docutils literal"><span class="pre">u</span></code> to represent <span class="math">\(u^n\)</span> as <code class="docutils literal"><span class="pre">u[n]</span></code>. The force <span class="math">\(F(t_n)\)</span> is
assumed to be available as an array element <code class="docutils literal"><span class="pre">F[n]</span></code>. The following
Python function computes <code class="docutils literal"><span class="pre">u</span></code> given  an array <code class="docutils literal"><span class="pre">t</span></code>
with time points <span class="math">\(t_0,t_1,\ldots\)</span>,
the initial displacement <code class="docutils literal"><span class="pre">I</span></code>, mass <code class="docutils literal"><span class="pre">m</span></code>, damping parameter <code class="docutils literal"><span class="pre">b</span></code>,
restoring force <code class="docutils literal"><span class="pre">s(u)</span></code>, environmental forces <code class="docutils literal"><span class="pre">F</span></code> as an array
(corresponding to <code class="docutils literal"><span class="pre">t</span></code>).</p>
</div>
<div class="section" id="simple-implementation">
<h2>Simple implementation<a class="headerlink" href="#simple-implementation" title="Permalink to this headline">¶</a></h2>
<p>Let us first implement the computational formulas for the linear
damping case in a short and compact Python function:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="o">*</span>

<span class="k">def</span> <span class="nf">solver_linear_damping</span><span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span>              <span class="c"># No of time intervals</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>            <span class="c"># Time step</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>              <span class="c"># Result array</span>
    <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">I</span>
    <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">dt</span><span class="o">*</span><span class="n">V</span> <span class="o">+</span> <span class="n">dt</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">m</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="n">b</span><span class="o">*</span><span class="n">V</span> <span class="o">-</span> <span class="n">s</span><span class="p">(</span><span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="n">F</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">N</span><span class="p">):</span>
        <span class="n">u</span><span class="p">[</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="p">(</span><span class="n">m</span> <span class="o">+</span> <span class="n">b</span><span class="o">*</span><span class="n">dt</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">m</span><span class="o">*</span><span class="n">u</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">+</span> \
                 <span class="p">(</span><span class="n">b</span><span class="o">*</span><span class="n">dt</span><span class="o">/</span><span class="mi">2</span> <span class="o">-</span> <span class="n">m</span><span class="p">)</span><span class="o">*</span><span class="n">u</span><span class="p">[</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">dt</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">F</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">-</span> <span class="n">s</span><span class="p">(</span><span class="n">u</span><span class="p">[</span><span class="n">n</span><span class="p">])))</span>
    <span class="k">return</span> <span class="n">u</span>
</pre></div>
</div>
</div>
<div class="section" id="dissection-of-the-code-1">
<h2>Dissection of the code<a class="headerlink" href="#dissection-of-the-code-1" title="Permalink to this headline">¶</a></h2>
<p>Functions in Python start with <code class="docutils literal"><span class="pre">def</span></code>, followed by the function name and
the list of input objects separated by comma. The function body is
indented, and the first non-indented line signifies the end of the function
body block. Output objects are returned to the calling code by a
<code class="docutils literal"><span class="pre">return</span></code> statement.</p>
<p>The arguments to this function and the variables created
inside the function are not declared with type. We therefore need to
know what the variables are supposed to be: <code class="docutils literal"><span class="pre">I</span></code>, <code class="docutils literal"><span class="pre">V</span></code>, <code class="docutils literal"><span class="pre">m</span></code>, and <code class="docutils literal"><span class="pre">b</span></code>
are real numbers, while <code class="docutils literal"><span class="pre">F</span></code> and <code class="docutils literal"><span class="pre">t</span></code> are one-dimensional arrays of
the same length, where <code class="docutils literal"><span class="pre">F</span></code> holds <span class="math">\(F(t_n)\)</span> and <code class="docutils literal"><span class="pre">t</span></code> holds <span class="math">\(t_n\)</span>,
<span class="math">\(n=0,1,\ldots,N+1\)</span>.</p>
<p>The number of elements in an array <code class="docutils literal"><span class="pre">t</span></code> is given by <code class="docutils literal"><span class="pre">t.size</span></code> (or
<code class="docutils literal"><span class="pre">len(t)</span></code>, but <code class="docutils literal"><span class="pre">t.size</span></code> works for multi-dimensional arrays too).
Arrays are indexed by square brackets, and indices always start at 0.
Numerical codes frequently needs to loop over array indices, i.e.,
a set of integers. Such a set
is produced by <code class="docutils literal"><span class="pre">range(start,</span> <span class="pre">stop,</span> <span class="pre">increment)</span></code>, which returns a
list of integers <code class="docutils literal"><span class="pre">start,</span> <span class="pre">start+increment,</span> <span class="pre">start+2*increment</span></code>, and so on,
up to <em>but not including</em> <code class="docutils literal"><span class="pre">stop</span></code>. Writing just <code class="docutils literal"><span class="pre">range(stop)</span></code> means
<code class="docutils literal"><span class="pre">range(0,</span> <span class="pre">stop,</span> <span class="pre">1)</span></code>. The particular call <code class="docutils literal"><span class="pre">range(1,</span> <span class="pre">N)</span></code> used in the code
above results in a list of integers: <code class="docutils literal"><span class="pre">1</span></code>, <code class="docutils literal"><span class="pre">2</span></code>, ..., <code class="docutils literal"><span class="pre">N-1</span></code>.</p>
<p>Array functionality is enabled by the <code class="docutils literal"><span class="pre">numpy</span></code> package, which offers
functions such as <code class="docutils literal"><span class="pre">zeros</span></code> and <code class="docutils literal"><span class="pre">linspace</span></code>, as known from Matlab.
Here we import all objects in the <code class="docutils literal"><span class="pre">numpy</span></code> package by the statement</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="o">*</span>
</pre></div>
</div>
<p>Comments start with the character <code class="docutils literal"><span class="pre">#</span></code> and the rest of the line
is then ignored by Python.</p>
<p>Every variable in Python is an object. In particular, the <code class="docutils literal"><span class="pre">s</span></code> function
above is a function object, transferred to the function as any other
object, and called as any other function. Transferring a function as
argument to another function is therefore simpler and cleaner in Python
than in, e.g., C, C++, Java, C#, and Matlab.</p>
<p>How can we use the <code class="docutils literal"><span class="pre">solver_linear_damping</span></code> function? We need to <em>call</em> it
with relevant values for the arguments. Suppose we want to solve
a vibration problem with <span class="math">\(I=1\)</span>, <span class="math">\(V=0\)</span>,
<span class="math">\(F=0\)</span>, <span class="math">\(m=2\)</span>, <span class="math">\(b=0.2\)</span>, <span class="math">\(s(u)=2u\)</span>, <span class="math">\(\Delta t=0.2\)</span>,
for <span class="math">\(t\in [0,10\pi]\)</span>. This will be a damped sinusoidal solution
(setting <span class="math">\(b=0\)</span> will result in <span class="math">\(u(t)=\cos t\)</span>).
The test code becomes</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">solver</span> <span class="kn">import</span> <span class="n">solver_linear_damping</span>
<span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="o">*</span>

<span class="k">def</span> <span class="nf">s</span><span class="p">(</span><span class="n">u</span><span class="p">):</span>
    <span class="k">return</span> <span class="mi">2</span><span class="o">*</span><span class="n">u</span>

<span class="n">T</span> <span class="o">=</span> <span class="mi">10</span><span class="o">*</span><span class="n">pi</span>      <span class="c"># simulate for t in [0,T]</span>
<span class="n">dt</span> <span class="o">=</span> <span class="mf">0.2</span>
<span class="n">N</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">T</span><span class="o">/</span><span class="n">dt</span><span class="p">))</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">N</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<span class="n">F</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
<span class="n">I</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">V</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">m</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="n">b</span> <span class="o">=</span> <span class="mf">0.2</span>
<span class="n">u</span> <span class="o">=</span> <span class="n">solver_linear_damping</span><span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">import</span> <span class="o">*</span>
<span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">u</span><span class="p">)</span>
<span class="n">savefig</span><span class="p">(</span><span class="s">&#39;tmp.pdf&#39;</span><span class="p">)</span>   <span class="c"># save plot to PDF file</span>
<span class="n">savefig</span><span class="p">(</span><span class="s">&#39;tmp.png&#39;</span><span class="p">)</span>   <span class="c"># save plot to PNG file</span>
<span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">solver_linear_damping</span></code> function resides in the file <code class="docutils literal"><span class="pre">solver.py</span></code>,
so if we make the call to this function in separate file (assumed above),
we have to import the function as shown. We also need functions and
variables from
the <code class="docutils literal"><span class="pre">numpy</span></code> package, here <code class="docutils literal"><span class="pre">pi</span></code>, <code class="docutils literal"><span class="pre">linspace</span></code>, and <code class="docutils literal"><span class="pre">zeros</span></code>.
Normally, there is one statement per line in Python programs, and there
is no need to end the statement with a semicolon. However, if we
want multiple statements on a line, they must be separated by semi colon
as demonstrated in the initialization of <code class="docutils literal"><span class="pre">I</span></code> and <code class="docutils literal"><span class="pre">V</span></code>. Plotting the
computed curve makes use of the <code class="docutils literal"><span class="pre">matplotlib</span></code> package, where we call
its <code class="docutils literal"><span class="pre">plot</span></code>, <code class="docutils literal"><span class="pre">savefig</span></code>, and <code class="docutils literal"><span class="pre">show</span></code> functions. Figure <a class="reference internal" href="#bumpy-fig0"><span class="std std-ref">Plot of computed curve</span></a>
shows the result.</p>
<div class="figure" id="id2">
<span id="bumpy-fig0"></span><a class="reference internal image-reference" href="_images/solver_linear_damping.png"><img alt="_images/solver_linear_damping.png" src="_images/solver_linear_damping.png" style="width: 500px;" /></a>
<p class="caption"><span class="caption-text"><em>Plot of computed curve</em></span></p>
</div>
</div>
<div class="section" id="more-advanced-implementation">
<h2>More advanced implementation<a class="headerlink" href="#more-advanced-implementation" title="Permalink to this headline">¶</a></h2>
<p>Let us extend the function above to also include the quadratic damping
formulas. The <span class="math">\(F(t)\)</span> function in <a class="reference internal" href="#eq-bumpy-eq1"><span class="std std-ref">(1)</span></a> is required to be
available as an array in the <code class="docutils literal"><span class="pre">solver_linear_damping</span></code> function, but
now we will allow for more flexibility: the <code class="docutils literal"><span class="pre">F</span></code> argument may either be
a Python function <code class="docutils literal"><span class="pre">F(t)</span></code> or a Python array. In addition, we add some
checks that variables have correct values or are of correct type.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>

<span class="k">def</span> <span class="nf">solver</span><span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">damping</span><span class="o">=</span><span class="s">&#39;linear&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Solve m*u&#39;&#39; + f(u&#39;) + s(u) = F for time points in t.</span>
<span class="sd">    u(0)=I and u&#39;(0)=V,</span>
<span class="sd">    by a central finite difference method with time step dt.</span>
<span class="sd">    If damping is &#39;linear&#39;, f(u&#39;)=b*u, while if damping is</span>
<span class="sd">    &#39;quadratic&#39;, we have f(u&#39;)=b*u&#39;*abs(u&#39;).</span>
<span class="sd">    s(u) is a Python function, while F may be a function</span>
<span class="sd">    or an array (then F[i] corresponds to F at t[i]).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span>              <span class="c"># No of time intervals</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>            <span class="c"># Time step</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>           <span class="c"># Result array</span>
    <span class="n">b</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">b</span><span class="p">);</span> <span class="n">m</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>  <span class="c"># Avoid integer division</span>

    <span class="c"># Convert F to array</span>
    <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">F</span><span class="p">):</span>
        <span class="n">F</span> <span class="o">=</span> <span class="n">F</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span><span class="nb">tuple</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
        <span class="n">F</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">F</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
            <span class="s">&#39;F must be function or array, not </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">F</span><span class="p">))</span>

    <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">I</span>
    <span class="k">if</span> <span class="n">damping</span> <span class="o">==</span> <span class="s">&#39;linear&#39;</span><span class="p">:</span>
        <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">dt</span><span class="o">*</span><span class="n">V</span> <span class="o">+</span> <span class="n">dt</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">m</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="n">b</span><span class="o">*</span><span class="n">V</span> <span class="o">-</span> <span class="n">s</span><span class="p">(</span><span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="n">F</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">damping</span> <span class="o">==</span> <span class="s">&#39;quadratic&#39;</span><span class="p">:</span>
        <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">dt</span><span class="o">*</span><span class="n">V</span> <span class="o">+</span> \
               <span class="n">dt</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">m</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="n">b</span><span class="o">*</span><span class="n">V</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="n">V</span><span class="p">)</span> <span class="o">-</span> <span class="n">s</span><span class="p">(</span><span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="n">F</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Wrong value: damping=&quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="n">damping</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">N</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">damping</span> <span class="o">==</span> <span class="s">&#39;linear&#39;</span><span class="p">:</span>
            <span class="n">u</span><span class="p">[</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">m</span><span class="o">*</span><span class="n">u</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">b</span><span class="o">*</span><span class="n">dt</span><span class="o">/</span><span class="mi">2</span> <span class="o">-</span> <span class="n">m</span><span class="p">)</span><span class="o">*</span><span class="n">u</span><span class="p">[</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span>
                      <span class="n">dt</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">F</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">-</span> <span class="n">s</span><span class="p">(</span><span class="n">u</span><span class="p">[</span><span class="n">n</span><span class="p">])))</span><span class="o">/</span><span class="p">(</span><span class="n">m</span> <span class="o">+</span> <span class="n">b</span><span class="o">*</span><span class="n">dt</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">damping</span> <span class="o">==</span> <span class="s">&#39;quadratic&#39;</span><span class="p">:</span>
            <span class="n">u</span><span class="p">[</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">m</span><span class="o">*</span><span class="n">u</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">-</span> <span class="n">m</span><span class="o">*</span><span class="n">u</span><span class="p">[</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">b</span><span class="o">*</span><span class="n">u</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="n">u</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">-</span> <span class="n">u</span><span class="p">[</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                      <span class="o">-</span> <span class="n">dt</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">s</span><span class="p">(</span><span class="n">u</span><span class="p">[</span><span class="n">n</span><span class="p">])</span> <span class="o">-</span> <span class="n">F</span><span class="p">[</span><span class="n">n</span><span class="p">]))</span><span class="o">/</span>\
                      <span class="p">(</span><span class="n">m</span> <span class="o">+</span> <span class="n">b</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="n">u</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">-</span> <span class="n">u</span><span class="p">[</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">u</span><span class="p">,</span> <span class="n">t</span>
</pre></div>
</div>
</div>
<div class="section" id="dissection-of-the-code-2">
<h2>Dissection of the code<a class="headerlink" href="#dissection-of-the-code-2" title="Permalink to this headline">¶</a></h2>
<p><strong>Two types of import.</strong>
This time we replace <code class="docutils literal"><span class="pre">from</span> <span class="pre">numpy</span> <span class="pre">import</span> <span class="pre">*</span></code>, which imports over 500
variables and functions, by <code class="docutils literal"><span class="pre">import</span> <span class="pre">numpy</span> <span class="pre">as</span> <span class="pre">np</span></code>, which just imports
one variable, the package <code class="docutils literal"><span class="pre">numpy</span></code>, here under the nickname <code class="docutils literal"><span class="pre">np</span></code>.
All variables and functions in <code class="docutils literal"><span class="pre">numpy</span></code> must now be reached via the
prefix <code class="docutils literal"><span class="pre">np.</span></code>, as in <code class="docutils literal"><span class="pre">np.zeros</span></code>, and <code class="docutils literal"><span class="pre">np.linspace</span></code>, and <code class="docutils literal"><span class="pre">np.pi</span></code> (for <span class="math">\(\pi\)</span>).
The advantage of the prefix is that we clearly see where functionality
comes from. The disadvantage is that mathematical formulas like
<span class="math">\(\sin (\pi x)\)</span> must be written <code class="docutils literal"><span class="pre">np.sin(np.pi*x)</span></code>. We can always perform
an explicit import of some names, like <code class="docutils literal"><span class="pre">sin</span></code> and <code class="docutils literal"><span class="pre">pi</span></code>, to write
the formula as <code class="docutils literal"><span class="pre">sin(pi*x)</span></code>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">sin</span><span class="p">,</span> <span class="n">pi</span>

<span class="k">def</span> <span class="nf">myfunction</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">sin</span><span class="p">(</span><span class="n">pi</span><span class="o">*</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
<p>Another disadvantage with the <code class="docutils literal"><span class="pre">np.</span></code> prefix is that names are no longer
(almost) the
same as in Matlab. Many will therefore prefer to do <code class="docutils literal"><span class="pre">from</span> <span class="pre">numpy</span> <span class="pre">import</span> <span class="pre">*</span></code>
and skip the prefix.</p>
<p id="index-0"><strong>Doc strings.</strong>
The string, enclosed in triple double-quotes, right after
the function definition, is a <em>doc string</em> used for documenting the
function. Various tools can extract function definitions and doc strings
to automatically produce nicely typeset manuals.</p>
<p><strong>Avoiding integer division.</strong>
At one line we explicitly convert <code class="docutils literal"><span class="pre">b</span></code> and <code class="docutils literal"><span class="pre">m</span></code> to <code class="docutils literal"><span class="pre">float</span></code> variables.
This is not strictly necessary, but if we supply <code class="docutils literal"><span class="pre">b=2</span></code> and <code class="docutils literal"><span class="pre">m=4</span></code>,
a computation like <code class="docutils literal"><span class="pre">b/m</span></code> will give zero as result because both <code class="docutils literal"><span class="pre">b</span></code> and <code class="docutils literal"><span class="pre">m</span></code>
are then integers and <code class="docutils literal"><span class="pre">b/m</span></code> implies <em>integer division</em>, not the
mathematical division of real numbers (this is not a special
feature of Python - all languages with a strong heritage from C
invoke integer division if both operands in a division are integers).
We need to make
sure that at least one of the operands in a division is a real
number (<code class="docutils literal"><span class="pre">float</span></code>) to ensure the intended mathematical operation. Looking at
the formulas, there is never a problem with integer division in
our implementation, because <code class="docutils literal"><span class="pre">dt</span></code> is computed from <code class="docutils literal"><span class="pre">t</span></code>, which has
<code class="docutils literal"><span class="pre">float</span></code> elements (<code class="docutils literal"><span class="pre">linspace</span></code> makes <code class="docutils literal"><span class="pre">float</span></code> elements by default),
and all divisions in our code involve <code class="docutils literal"><span class="pre">dt</span></code> as one of the operands.
However, future edits may alter the way formulas are written, so to
be on the safe side we ensure that real input parameters are <code class="docutils literal"><span class="pre">float</span></code>
objects.</p>
<p><strong>Flexible variable type.</strong>
As mentioned, we allow <code class="docutils literal"><span class="pre">F</span></code> to be either a function or an array.
In the former case, we convert <code class="docutils literal"><span class="pre">F</span></code> to an array such that the
rest of the code can assume that <code class="docutils literal"><span class="pre">F</span></code> is indeed an array.
It is easy to check the type of variables in Python. The
test <code class="docutils literal"><span class="pre">if</span> <span class="pre">callable(F)</span></code> is true if the object <code class="docutils literal"><span class="pre">F</span></code> can be called
as a function.</p>
<p><strong>Checking correct variable type.</strong>
To test that <code class="docutils literal"><span class="pre">F</span></code> is an array, we can use <code class="docutils literal"><span class="pre">isinstance(F,</span> <span class="pre">np.ndarray)</span></code>
(<code class="docutils literal"><span class="pre">ndarray</span></code> is the name of the array type in <code class="docutils literal"><span class="pre">numpy</span></code>). In the code
above we allow that <code class="docutils literal"><span class="pre">F</span></code> can also be a list or a tuple. Running <code class="docutils literal"><span class="pre">F</span></code>
through the <code class="docutils literal"><span class="pre">asarray</span></code> function makes an array out of <code class="docutils literal"><span class="pre">F</span></code> in the cases
where <code class="docutils literal"><span class="pre">F</span></code> is a list or tuple. The final <code class="docutils literal"><span class="pre">else:</span></code> clause takes care of
the situation where <code class="docutils literal"><span class="pre">F</span></code> is neither a function, nor an object that can
easily be converted to an array, and an error message is issued. More
precisely, we <em>raise</em> a <code class="docutils literal"><span class="pre">TypeError</span></code> <em>exception</em> indicating that we
have encountered a wrong type. The error message will contain the type
of <code class="docutils literal"><span class="pre">F</span></code> as obtained from <code class="docutils literal"><span class="pre">type(F)</span></code>. Instead of using the syntax <code class="docutils literal"><span class="pre">isinstance(F,</span>
<span class="pre">list)</span></code> we may test <code class="docutils literal"><span class="pre">type(F)</span> <span class="pre">==</span> <span class="pre">list</span></code> or even <code class="docutils literal"><span class="pre">type(F)</span> <span class="pre">in</span>
<span class="pre">(list,tuple,np.ndarray)</span></code>.</p>
<p>We could simplify the <code class="docutils literal"><span class="pre">if-else</span></code> test involving <code class="docutils literal"><span class="pre">F</span></code> to just the two lines</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">F</span><span class="p">):</span>
    <span class="n">F</span> <span class="o">=</span> <span class="n">F</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
</pre></div>
</div>
<p>if we are sure that <code class="docutils literal"><span class="pre">F</span></code> is either a function or a <code class="docutils literal"><span class="pre">numpy</span></code> array.
Should the user send in something else for <code class="docutils literal"><span class="pre">F</span></code>, Python will encounter
a run-time error when trying to index <code class="docutils literal"><span class="pre">F</span></code> as in <code class="docutils literal"><span class="pre">F[0]</span></code> (in the
statement computing <code class="docutils literal"><span class="pre">u[1]</span></code>).</p>
<p>To be absolutely safe, we should test that the other arguments are
of right type as well. For example,</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span><span class="nb">int</span><span class="p">)):</span>
    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;V must be float or int, not </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">V</span><span class="p">))</span>
</pre></div>
</div>
<p>and similar for <code class="docutils literal"><span class="pre">V</span></code>, <code class="docutils literal"><span class="pre">m</span></code>, <code class="docutils literal"><span class="pre">b</span></code>, while <code class="docutils literal"><span class="pre">s</span></code> must be tested by <code class="docutils literal"><span class="pre">callable(s)</span></code>,
<code class="docutils literal"><span class="pre">t</span></code> must be <code class="docutils literal"><span class="pre">np.ndarray</span></code>, and <code class="docutils literal"><span class="pre">damping</span></code> must be <code class="docutils literal"><span class="pre">str</span></code>.</p>
<p><strong>Calling the function.</strong>
Below is a simple example on how the <code class="docutils literal"><span class="pre">solver</span></code> function can be called
to solve the differential equation problem <span class="math">\(mu'' + bu' + ku = A\sin\pi t\)</span>,
<span class="math">\(u(0)=I\)</span>, <span class="math">\(u'(0)=0\)</span>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">sin</span><span class="p">,</span> <span class="n">pi</span>  <span class="c"># for nice math</span>

<span class="k">def</span> <span class="nf">F</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
    <span class="c"># Sinusoidal bumpy road</span>
    <span class="k">return</span> <span class="n">A</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">pi</span><span class="o">*</span><span class="n">t</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">s</span><span class="p">(</span><span class="n">u</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">k</span><span class="o">*</span><span class="n">u</span>

<span class="n">A</span> <span class="o">=</span> <span class="mf">0.25</span>
<span class="n">k</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">2001</span><span class="p">)</span>
<span class="n">u</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">solver</span><span class="p">(</span><span class="n">I</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">V</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">m</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="p">,</span> <span class="n">F</span><span class="o">=</span><span class="n">F</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="n">t</span><span class="p">)</span>

<span class="c"># Show u(t) as a curve plot</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">u</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<p><strong>Local and global variables.</strong>
We use in this example a linear spring function <span class="math">\(s(u)\)</span>,</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">u</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">k</span><span class="o">*</span><span class="n">u</span>
</pre></div>
</div>
<p>Here, <code class="docutils literal"><span class="pre">u</span></code> is a <em>local variable</em>,
which is accessible just inside in the function,
while <code class="docutils literal"><span class="pre">k</span></code> is a <em>global variable</em>, which must be initialized outside
the function prior to calling <code class="docutils literal"><span class="pre">f</span></code>.</p>
<div class="admonition-advanced-programming-of-functions-with-parameters admonition">
<p class="first admonition-title">Advanced programming of functions with parameters</p>
<p>The best way to implement mathematical functions that has a set
of parameters in addition some
independent variables is to create a <em>class</em> where
the parameters are attributes and a <code class="docutils literal"><span class="pre">__call__</span></code> method evaluates
the function formula given the independent variables as arguments.
This requires, of course,
knowledge of classes and special methods like <code class="docutils literal"><span class="pre">__call__</span></code>.</p>
<p>As an example, the <code class="docutils literal"><span class="pre">f(u)</span></code> function above can be implemented as</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Spring</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="n">k</span>
    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">u</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="o">*</span><span class="n">u</span>

<span class="n">f</span> <span class="o">=</span> <span class="n">Spring</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
</pre></div>
</div>
<p class="last">Because of the <code class="docutils literal"><span class="pre">__call__</span></code> method, we can make calls <code class="docutils literal"><span class="pre">f(u)</span></code>. Note that
the <code class="docutils literal"><span class="pre">k</span></code> parameter is bundled with the function in the <code class="docutils literal"><span class="pre">f</span></code> object.</p>
</div>
</div>
<div class="section" id="the-excitation-force">
<h2>The excitation force<a class="headerlink" href="#the-excitation-force" title="Permalink to this headline">¶</a></h2>
<p>Considering the application where the present mathematical model describes
the vibrations of a vehicle driving along a bumpy road, we need
to establish the force array <code class="docutils literal"><span class="pre">F</span></code> from the shape of the road <span class="math">\(h(x)\)</span>.
Various shapes are
available as a file with web address <a class="reference external" href="http://hplbit.bitbucket.org/data/bumpy/bumpy.dat.gz">http://hplbit.bitbucket.org/data/bumpy/bumpy.dat.gz</a>. The Python functionality for downloading this <code class="docutils literal"><span class="pre">gzip</span></code>
compressed file as a local file <code class="docutils literal"><span class="pre">bumpy.dat.gz</span></code>
and reading it into a <code class="docutils literal"><span class="pre">numpy</span></code> array goes as follows:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">filename</span> <span class="o">=</span> <span class="s">&#39;bumpy.dat.gz&#39;</span>
<span class="n">url</span> <span class="o">=</span> <span class="s">&#39;http://hplbit.bitbucket.org/data/bumpy/bumpy.dat.gz&#39;</span>
<span class="kn">import</span> <span class="nn">urllib</span>
<span class="n">urllib</span><span class="o">.</span><span class="n">urlretrieve</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
<span class="n">h_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>     <span class="c"># read numpy array from file</span>
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">h_data</span></code> object is a rectangular <code class="docutils literal"><span class="pre">numpy</span></code> array where the first
column contains the <span class="math">\(x\)</span> coordinates along the road and the next columns
contain various road shapes <span class="math">\(h(x)\)</span>. We can extract the <span class="math">\(x\)</span> data and
redefine <code class="docutils literal"><span class="pre">h_data</span></code> to contain solely the <span class="math">\(h(x)\)</span> shapes:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">x</span> <span class="o">=</span> <span class="n">h_data</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span>                <span class="c"># 1st column: x coordinates</span>
<span class="n">h_data</span> <span class="o">=</span> <span class="n">h_data</span><span class="p">[</span><span class="mi">1</span><span class="p">:,:]</span>          <span class="c"># other columns: h shapes</span>
</pre></div>
</div>
<p>In general, the syntax <code class="docutils literal"><span class="pre">a[s:t:i,2]</span></code> gives a <em>view</em> (not a copy) to the part of
the array <code class="docutils literal"><span class="pre">a</span></code> where the first index goes from <code class="docutils literal"><span class="pre">s</span></code> to <code class="docutils literal"><span class="pre">t</span></code>,
<em>but not including</em> the <code class="docutils literal"><span class="pre">t</span></code> value, in increments of <code class="docutils literal"><span class="pre">i</span></code>, and the
second index is fixed at 2. Just writing <code class="docutils literal"><span class="pre">:</span></code> for an index means all
legal values of this index.</p>
<p>Given <span class="math">\(h(x)\)</span>, the corresponding acceleration <span class="math">\(a(t)\)</span> needed in the
force <span class="math">\(F(t)=-ma(t)\)</span>, follows from <span class="math">\(a(t)=h''(vt)v^2\)</span>, where <span class="math">\(v\)</span> is
the velocity of the vehicle. The computation may utilize a finite
difference approximation for the second-order derivative <span class="math">\(h''\)</span> and
be encapsulated in a Python function:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">acceleration</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compute 2nd-order derivative of h.&quot;&quot;&quot;</span>
    <span class="c"># Method: standard finite difference aproximation</span>
    <span class="n">d2h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
    <span class="n">dx</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">h</span><span class="o">.</span><span class="n">size</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">d2h</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">h</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">h</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="n">dx</span><span class="o">**</span><span class="mi">2</span>
    <span class="c"># Extraplolate end values from first interior value</span>
    <span class="n">d2h</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">d2h</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">d2h</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">d2h</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">d2h</span><span class="o">*</span><span class="n">v</span><span class="o">**</span><span class="mi">2</span>
    <span class="k">return</span> <span class="n">a</span>
</pre></div>
</div>
<p>Note that here, <code class="docutils literal"><span class="pre">h</span></code> is a one-dimensional array containing the <span class="math">\(h(x)\)</span>
values corresponding to a given coordinate array <code class="docutils literal"><span class="pre">x</span></code>. Also note that
we for mathematical simplicity set <span class="math">\(h''(x)\)</span> at the end points equal to
<span class="math">\(h''(x)\)</span> at the closest interior point.</p>
<p>The computations of <code class="docutils literal"><span class="pre">d2h</span></code> above was done array element by array element.
This loop can be a slow process in Python for long arrays. To speed
up computations dramatically, we can invoke a <em>vectorization</em> of
the above algorithm. This means that we get rid of the loops and
perform arithmetics on complete (or almost complete) arrays.
The vectorized form of the
<code class="docutils literal"><span class="pre">acceleration</span></code> function goes like</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">acceleration_vectorized</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compute 2nd-order derivative of h. Vectorized version.&quot;&quot;&quot;</span>
    <span class="n">d2h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
    <span class="n">dx</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">d2h</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">h</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">h</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">h</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span><span class="o">/</span><span class="n">dx</span><span class="o">**</span><span class="mi">2</span>
    <span class="c"># Extraplolate end values from first interior value</span>
    <span class="n">d2h</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">d2h</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">d2h</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">d2h</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">d2h</span><span class="o">*</span><span class="n">v</span><span class="o">**</span><span class="mi">2</span>
    <span class="k">return</span> <span class="n">a</span>
</pre></div>
</div>
<p>For each shape <span class="math">\(h(x)\)</span> we want to compute the corresponding
vertical displacement <span class="math">\(u(t)\)</span> using the mathematical model <a class="reference internal" href="#eq-bumpy-eq1"><span class="std std-ref">(1)</span></a>.
This can be accomplished by looping over the columns of <code class="docutils literal"><span class="pre">h_data</span></code> and
calling <code class="docutils literal"><span class="pre">solver</span></code> for each column, i.e., each realization of
the force <span class="math">\(F\)</span>.
The major arrays from the computations
are collected in a list <code class="docutils literal"><span class="pre">data</span></code>. The two first elements in
<code class="docutils literal"><span class="pre">data</span></code> are <code class="docutils literal"><span class="pre">x</span></code> and <code class="docutils literal"><span class="pre">t</span></code>. The next elements are
3-lists <code class="docutils literal"><span class="pre">[h,</span> <span class="pre">a,</span> <span class="pre">u]</span></code> for each road shape.
Note that some elements in <code class="docutils literal"><span class="pre">data</span></code> are arrays while others are list of
arrays. This composition is convenient when analyzing and visualizing
key quantities in the problem.</p>
<p>The computations of <code class="docutils literal"><span class="pre">u</span></code> for each road shape can be done as follows:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span>      <span class="c"># key input and output data (arrays)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">h_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">h_data</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span>            <span class="c"># extract a column</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">acceleration</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
    <span class="n">F</span> <span class="o">=</span> <span class="o">-</span><span class="n">m</span><span class="o">*</span><span class="n">a</span>

    <span class="n">u</span> <span class="o">=</span> <span class="n">solver</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="n">t</span><span class="p">,</span> <span class="n">I</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">m</span><span class="o">=</span><span class="n">m</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="n">b</span><span class="p">,</span> <span class="n">f</span><span class="o">=</span><span class="n">f</span><span class="p">,</span> <span class="n">F</span><span class="o">=</span><span class="n">F</span><span class="p">)</span>

    <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">h</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">u</span><span class="p">])</span>
</pre></div>
</div>
<p>A parameter choice <span class="math">\(m=60\)</span> kg, <span class="math">\(v=5\)</span> m/s, <span class="math">\(k=60\)</span> N/m,
and <span class="math">\(b=80\)</span> Ns/m
corresponds to a velocity of 18 km/h and a mass of 60 kg, i.e.,
bicycle conditions.</p>
</div>
<div class="section" id="a-high-level-solve-function">
<h2>A high-level solve function<a class="headerlink" href="#a-high-level-solve-function" title="Permalink to this headline">¶</a></h2>
<p>The code above for simulating vertical vibrations in a vehicle
is naturally implemented as a Python function.
This function can take the most important physical parameters of the problem
as input, along with information about the file with road shapes.
We allow for defining road shapes either through a file on a web site
or a local file.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">bumpy_road</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">m</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">v</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Simulate vertical vehicle vibrations.</span>

<span class="sd">    =========   ==============================================</span>
<span class="sd">    variable    description</span>
<span class="sd">    =========   ==============================================</span>
<span class="sd">    url         either URL of file with excitation force data,</span>
<span class="sd">                or name of a local file</span>
<span class="sd">    m           mass of system</span>
<span class="sd">    b           friction parameter</span>
<span class="sd">    k           spring parameter</span>
<span class="sd">    v           (constant) velocity of vehicle</span>
<span class="sd">    Return      data (list) holding input and output data</span>
<span class="sd">                [x, t, [h,F,u], [h,F,u], ...]</span>
<span class="sd">    =========   ==============================================</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># Download file (if url is not the name of a local file)</span>
    <span class="k">if</span> <span class="n">url</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;http://&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">url</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;file://&#39;</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">urllib</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>  <span class="c"># strip off path</span>
        <span class="n">urllib</span><span class="o">.</span><span class="n">urlretrieve</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c"># Check if url is the name of a local file</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">url</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
            <span class="k">print</span> <span class="n">url</span><span class="p">,</span> <span class="s">&#39;must be a URL or a filename&#39;</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c"># abort program</span>
        <span class="c"># else: ok</span>

    <span class="n">h_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>  <span class="c"># read numpy array from file</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">h_data</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span>                <span class="c"># 1st column: x coordinates</span>
    <span class="n">h_data</span> <span class="o">=</span> <span class="n">h_data</span><span class="p">[</span><span class="mi">1</span><span class="p">:,:]</span>          <span class="c"># other columns: h shapes</span>

    <span class="n">t</span> <span class="o">=</span> <span class="n">x</span><span class="o">/</span><span class="n">v</span>                        <span class="c"># time corresponding to x</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">u</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">k</span><span class="o">*</span><span class="n">u</span>

    <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span>      <span class="c"># key input and output data (arrays)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">h_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">h_data</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span>            <span class="c"># extract a column</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">acceleration</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
        <span class="n">F</span> <span class="o">=</span> <span class="o">-</span><span class="n">m</span><span class="o">*</span><span class="n">a</span>

        <span class="n">u</span> <span class="o">=</span> <span class="n">solver</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="n">t</span><span class="p">,</span> <span class="n">I</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">m</span><span class="o">=</span><span class="n">m</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="n">b</span><span class="p">,</span> <span class="n">f</span><span class="o">=</span><span class="n">f</span><span class="p">,</span> <span class="n">F</span><span class="o">=</span><span class="n">F</span><span class="p">)</span>

        <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">h</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">u</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">data</span>
</pre></div>
</div>
<p>Note that function arguments can be given default values (known as
<em>keyword arguments</em> in Python). Python has a lot of operating
system functionality, such as
checking if a file, directory, or link exist, creating or
removing files and directories, running stand-alone applications, etc.</p>
</div>
<div class="section" id="storing-python-objects-in-files">
<h2>Storing Python objects in files<a class="headerlink" href="#storing-python-objects-in-files" title="Permalink to this headline">¶</a></h2>
<p id="index-1">After calling</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">road_url</span> <span class="o">=</span> <span class="s">&#39;http://hplbit.bitbucket.org/data/bumpy/bumpy.dat.gz&#39;</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">road_url</span><span class="p">,</span> <span class="n">m</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">v</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
</pre></div>
</div>
<p>the <code class="docutils literal"><span class="pre">data</span></code> array contains single arrays and triplets of arrays,</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="p">[</span><span class="n">h</span><span class="p">,</span><span class="n">F</span><span class="p">,</span><span class="n">u</span><span class="p">],</span> <span class="p">[</span><span class="n">h</span><span class="p">,</span><span class="n">F</span><span class="p">,</span><span class="n">u</span><span class="p">],</span> <span class="o">...</span><span class="p">,</span> <span class="p">[</span><span class="n">h</span><span class="p">,</span><span class="n">F</span><span class="p">,</span><span class="n">u</span><span class="p">]]</span>
</pre></div>
</div>
<p>This list, or any Python object, can be stored on file for later
retrieval of the results, using the <em>pickling</em> functionality
in Python:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">cPickle</span> <span class="kn">as</span> <span class="nn">pickle</span>
<span class="c"># Or using a more advanced module</span>
<span class="kn">import</span> <span class="nn">dill</span> <span class="kn">as</span> <span class="nn">pickle</span>
<span class="n">outfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;bumpy.res&#39;</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>
<span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">outfile</span><span class="p">)</span>
<span class="n">outfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
<p>The advantage of the <code class="docutils literal"><span class="pre">dill</span></code> module over <code class="docutils literal"><span class="pre">cPickle</span></code> is that it can
store a wider range of Python objects (e.g., lambda functions).</p>
<p>The code above and the <code class="docutils literal"><span class="pre">bumpy_road</span></code> function are found in the
file
<a class="reference external" href="https://github.com/hplgit/bumpy/blob/master/doc/src/src-bumpy/bumpy.py">bumpy.py</a>.</p>
</div>
<div class="section" id="computing-the-root-mean-square-value">
<h2>Computing the root mean square value<a class="headerlink" href="#computing-the-root-mean-square-value" title="Permalink to this headline">¶</a></h2>
<p>Since the roads have a quite noise shape, the force <span class="math">\(F=-ma\)</span> looks
very noisy, while the response <span class="math">\(u(t)\)</span> to this excitation is
significantly less noisy,
see the bottom plot in Figure <a class="reference internal" href="._bumpy003.html#bumpy-fig4"><span class="std std-ref">First realization of a bumpy road, with corresponding excitation of the wheel and resulting vertical vibrations</span></a> for an example.
It may be useful to compute the <a class="reference external" href="http://en.wikipedia.org/wiki/Root_mean_square">root mean square value</a> of <span class="math">\(u\)</span> to get
a number for the typical amplitude of the vibrations:</p>
<div class="math">
\[u_{\mbox{rms}} =
\sqrt{T^{-1}\int_0^T u^2dt} \approx \sqrt{\frac{1}{N+1}\sum_{i=0}^N (u^n)^2}
\thinspace .\]</div>
<p>The last expression can be computed as follows using a vectorized
sum (<code class="docutils literal"><span class="pre">np.sum(u**2)</span></code>):</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">u_rms</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">h</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">:]:</span>
    <span class="n">u_rms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="mf">1.</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">u</span><span class="p">))</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">u</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
</pre></div>
</div>
<p id="index-2">Very often in numerical computing we have some list/array and want
to compute a new list/array where each element is some expression
involving an element of the first list/array, typically</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">v</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">u</span><span class="p">:</span>
    <span class="n">v</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">expression</span><span class="p">(</span><span class="n">element</span><span class="p">))</span>
</pre></div>
</div>
<p>This code can more compactly be written as a <em>list comprehension</em>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">v</span> <span class="o">=</span> <span class="p">[</span><span class="n">expression</span><span class="p">(</span><span class="n">element</span><span class="p">)</span> <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">u</span><span class="p">]</span>
</pre></div>
</div>
<p>We may use the list comprehension construction for computing the <code class="docutils literal"><span class="pre">u_rms</span></code>
values:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">u_rms</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="mf">1.</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">u</span><span class="p">))</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">u</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
         <span class="k">for</span> <span class="n">h</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">:]]</span>
</pre></div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <center>
            <p class="logo"><a href="http://cbc.simula.no/" title="Go to Center for Biomedical Computing">
              <img class="logo" src="_static/cbc_logo.png" alt="Logo"/>
            </a></p>
            </center>
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">A scientific application</a><ul>
<li><a class="reference internal" href="#physical-problem-and-mathematical-model">Physical problem and mathematical model</a></li>
<li><a class="reference internal" href="#numerical-model">Numerical model</a></li>
<li><a class="reference internal" href="#simple-implementation">Simple implementation</a></li>
<li><a class="reference internal" href="#dissection-of-the-code-1">Dissection of the code</a></li>
<li><a class="reference internal" href="#more-advanced-implementation">More advanced implementation</a></li>
<li><a class="reference internal" href="#dissection-of-the-code-2">Dissection of the code</a></li>
<li><a class="reference internal" href="#the-excitation-force">The excitation force</a></li>
<li><a class="reference internal" href="#a-high-level-solve-function">A high-level solve function</a></li>
<li><a class="reference internal" href="#storing-python-objects-in-files">Storing Python objects in files</a></li>
<li><a class="reference internal" href="#computing-the-root-mean-square-value">Computing the root mean square value</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="._bumpy000.html"
                        title="previous chapter">A worked example on scientific computing with Python</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="._bumpy002.html"
                        title="next chapter">User input</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/._bumpy001.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="._bumpy002.html" title="User input"
             >next</a> |</li>
        <li class="right" >
          <a href="._bumpy000.html" title="A worked example on scientific computing with Python"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">A worked example on scientific computing with Python</a> &raquo;</li> 
      </ul>
    </div>
<div class="wrapper">
  <div class="footer">
    <a href="http://cbc.simula.no"><img src="_static/cbc_banner.png" width="100%"><a>
    <br />
    <br />
      &copy;H. P. Langtangen.
  </div>
</div>

  </body>
</html>